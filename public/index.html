<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clinical Dashboard | RISA Labs — Final (Vercel-ready)</title>

  <!-- Tailwind CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons + Chart.js -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <!-- PDF export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Basic visual theming */
    body { font-family: 'Inter', sans-serif; background-color: #fcfcfd; color: #0f172a; line-height: 1.45; }
    .clinical-card { background: white; border: 1px solid #e9eaec; border-radius: 6px; }
    .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; border: 1px solid transparent; display:inline-block;}
    .bg-pd { background-color: #fff1f2; color: #9f1239; border-color: #fecdd3; }
    .bg-pr { background-color: #f0fdf4; color: #166534; border-color: #dcfce7; }
    .bg-sd { background-color: #eff6ff; color: #1e40af; border-color: #dbeafe; }
    .bg-cr { background-color: #faf5ff; color: #6b21a8; border-color: #f3e8ff; }
    .bg-baseline { background-color: #f8fafc; color: #475569; border-color: #e2e8f0; }
    .timeline-line { position: absolute; left: 7px; top: 0; bottom: 0; width: 1px; background: #e2e8f0; }
    .next-steps-box { background-color: #eef2ff; border: 1px solid #c7d2fe; border-radius: 6px; }
    .timeline-dot { width: 14px; height: 14px; border-radius: 50%; background: white; border: 2px solid #cbd5e1; position: relative; z-index: 10; }
    .timeline-dot.active { border-color: #4f46e5; background: #4f46e5; }
    .ai-panel { background-color: #f8faff; border: 1px solid #e0e7ff; border-radius: 6px; }
    .clinical-card { min-height: 48px; }
    html,body { height: 100%; overflow-x: hidden; }

    /* Accessibility / focus styles */
    :focus { outline: none; }
    :focus-visible { outline: 3px solid rgba(79,70,229,0.25); outline-offset: 2px; border-radius: 4px; }
    [role="button"] { cursor: pointer; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    .focus-ring { box-shadow: 0 0 0 4px rgba(79,70,229,0.12); border-radius: 6px; }

    /* Layout / sizing fixes */
    #timelineContainer { min-height: 260px; max-height: 520px; overflow-y: auto; padding-right: 8px; }
    #biomarkerChart { width: 100% !important; height: 260px !important; display: block; }
    .md\:col-span-6.border-l { min-height: 260px; }
    .ai-panel ul { margin: 0; padding: 0; }
    #aiSummaryPoints li { list-style: none; }
    /* small screens */
    @media (max-width: 768px) {
      #biomarkerChart { height: 220px !important; }
      #timelineContainer { min-height: 200px; }
    }

    /* Improve contrast for low-contrast text classes used earlier */
    .text-slate-400 { color: #6b7280 !important; } /* slightly darker */
    .text-slate-300 { color: #9ca3af !important; }
    .text-slate-500 { color: #374151 !important; }

    /* Treatment accordion animations */
    .animate-open { animation: accordionOpen 200ms ease-out forwards; }
    .animate-close { animation: accordionClose 160ms ease-in forwards; }
    @keyframes accordionOpen { from { opacity: 0; transform: translateY(-6px);} to { opacity: 1; transform: none; } }
    @keyframes accordionClose { from { opacity: 1; } to { opacity: 0; height: 0; padding: 0; margin: 0; } }
  </style>
</head>
<body class="p-6 lg:p-8 max-w-[1400px] mx-auto" id="root">
  <a href="#mainContent" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:bg-indigo-600 focus:text-white focus:p-4 focus:z-50 focus:rounded focus:font-bold">
    Skip to main content
  </a>

  <!-- Header & Patient selector -->
  <header class="flex flex-col md:flex-row md:items-end justify-between mb-6 gap-4 border-b border-slate-100 pb-6" role="banner">
    <div class="space-y-1">
      <h1 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Clinical Review Interface</h1>
      <div class="flex items-center gap-3">
        <label for="patientSelect" class="sr-only">Select patient</label>
        <select id="patientSelect" onchange="loadPatient()" class="w-72 p-2 text-sm font-semibold border border-slate-200 rounded-sm outline-none focus-visible:ring-2 focus-visible:ring-indigo-200 transition-colors" aria-label="Select patient"></select>
        <button id="exportBtn" onclick="exportPatientSummaryPDF()" class="px-3 py-2 text-sm font-bold bg-indigo-600 text-white rounded shadow hover:bg-indigo-700 focus-visible:ring-2 focus-visible:ring-indigo-300" aria-label="Export PDF summary">Export PDF</button>
      </div>
    </div>

    <div class="text-right">
      <div class="text-xs font-semibold text-slate-500">Environment</div>
      <div class="text-sm font-bold text-slate-700">Static Vercel build (Client-only)</div>
    </div>
  </header>

  <main id="mainContent" role="main" class="mb-8">
    <div id="clinicalUpdates" class="mb-4 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-sm shadow-sm" aria-live="polite" aria-atomic="true"></div>

    <!-- Top summary + tabs -->
    <section class="clinical-card p-4 mb-6" role="region" aria-label="Patient summary">
      <div class="flex items-start justify-between gap-4">
        <div id="topSummary" class="flex-1"></div>
        <div class="w-[260px] flex flex-col gap-2">
          <div class="clinical-card p-3">
            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Codes</div>
            <div id="icd10-display" class="text-sm font-semibold text-slate-700">ICD-10: —</div>
            <div id="snomed-display" class="text-sm font-semibold text-slate-700 mt-1">SNOMED: —</div>
            <div class="text-[10px] text-slate-400 mt-2">(SNOMED lookup requires a configured API - see README)</div>
          </div>
          <div class="clinical-card p-3">
            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-2">Quick Actions</div>
            <div class="flex gap-2">
              <button onclick="copyPatientLink()" class="px-2 py-1 text-xs font-semibold border border-slate-200 rounded hover:bg-slate-50 focus-visible:ring-2 focus-visible:ring-indigo-200">Copy link</button>
              <button onclick="openShareModal()" class="px-2 py-1 text-xs font-semibold border border-slate-200 rounded hover:bg-slate-50 focus-visible:ring-2 focus-visible:ring-indigo-200">Share</button>
              <button onclick="openPatientInNewTab()" class="px-2 py-1 text-xs font-semibold border border-slate-200 rounded hover:bg-slate-50 focus-visible:ring-2 focus-visible:ring-indigo-200">Open in new tab</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mt-4">
        <div role="tablist" aria-label="Patient tabs" class="flex gap-2 mb-3">
          <button id="tab-overview" role="tab" aria-selected="true" aria-controls="panel-overview" class="px-3 py-1 text-sm font-bold bg-indigo-600 text-white rounded focus-visible:ring-2 focus-visible:ring-indigo-300" onclick="switchTab('overview')">Overview</button>
          <button id="tab-timeline" role="tab" aria-selected="false" aria-controls="panel-timeline" class="px-3 py-1 text-sm font-bold border border-slate-200 rounded focus-visible:ring-2 focus-visible:ring-indigo-200" onclick="switchTab('timeline')">Timeline</button>
        </div>

        <div id="panel-overview" role="tabpanel">
          <!-- container for overview content (left + right columns moved below in panels) -->
        </div>
        <div id="panel-timeline" role="tabpanel" hidden>
          <!-- timeline panel -->
        </div>
        <div id="panel-molecular" role="tabpanel" hidden>
          <!-- molecular panel -->
        </div>
        <div id="panel-labs" role="tabpanel" hidden>
          <!-- labs panel -->
        </div>
      </div>
    </section>

    <!-- Panels layout will be injected into the tab panels by JS -->
  </main>

  <!-- Sidebars -->
  <div id="sidebarBackdrop" onclick="closeSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-[1px] z-40 hidden transition-opacity opacity-0" aria-hidden="true"></div>
  <aside id="eventSidebar" class="fixed top-0 right-0 bottom-0 w-[450px] bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col border-l border-slate-100" role="dialog" aria-modal="true" aria-labelledby="sidebarEvent" aria-hidden="true">
    <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-start">
      <div>
        <div id="sidebarDate" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1"></div>
        <h3 id="sidebarEvent" class="text-lg font-bold text-slate-800 leading-tight"></h3>
      </div>
      <button onclick="closeSidebar()" class="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-600 transition-colors" aria-label="Close event sidebar">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-6">
      <div class="flex items-center justify-between bg-slate-50 p-3 rounded border border-slate-100">
        <span class="text-xs font-semibold text-slate-500">Clinical Impact</span>
        <span id="sidebarBadge"></span>
      </div>
      <div id="sidebarContent" class="space-y-6"></div>
    </div>

    <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
      <span class="text-[10px] text-slate-400 italic mr-2">Signed electronically</span>
      <button onclick="closeSidebar()" class="px-4 py-2 bg-indigo-600 text-white text-xs font-bold rounded shadow-sm hover:bg-indigo-700 transition-colors">Done</button>
    </div>
  </aside>

  <div id="labSidebarBackdrop" onclick="closeLabSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-[1px] z-[60] hidden transition-opacity opacity-0" aria-hidden="true"></div>
  <aside id="labSidebar" class="fixed top-0 right-0 bottom-0 w-[500px] bg-white shadow-2xl z-[70] transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col border-l border-slate-100" role="dialog" aria-modal="true" aria-labelledby="labSidebarTitle" aria-hidden="true">
    <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
      <div>
        <h3 id="labSidebarTitle" class="text-lg font-black text-slate-800 uppercase tracking-tight"></h3>
        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Safety & Trend Analysis</p>
      </div>
      <button onclick="closeLabSidebar()" class="p-2 hover:bg-slate-200 rounded-full text-slate-400 hover:text-slate-600 transition-colors" aria-label="Close lab sidebar">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="flex-1 overflow-y-auto p-6">
      <div class="grid grid-cols-2 gap-4 mb-8">
        <div class="bg-indigo-50/50 p-4 rounded border border-indigo-100">
          <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Current Level</span>
          <div class="flex items-baseline gap-1">
            <span id="labSidebarValue" class="text-3xl font-black text-indigo-900"></span>
            <span id="labSidebarUnit" class="text-xs font-bold text-indigo-400"></span>
          </div>
        </div>
        <div class="flex flex-col justify-center pl-4 border-l border-slate-100">
          <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Reference Range</span>
          <div id="labSidebarRange" class="text-sm font-bold text-slate-600 mb-2"></div>
          <div id="labSidebarStatus"></div>
        </div>
      </div>

      <div class="mb-6">
        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
          <i data-lucide="activity" class="w-3 h-3"></i> Historical Trend
        </h4>
        <div class="h-[280px] w-full relative border border-slate-100 rounded bg-slate-50/30 p-2">
          <canvas id="sidebarLabChart" aria-label="Lab trend chart"></canvas>
        </div>
        <div class="mt-3 text-[10px] text-slate-400 italic text-center">
          <span class="inline-block w-3 h-0.5 bg-red-400 align-middle mr-1"></span> Dashed lines indicate normal safety limits.
        </div>
      </div>
    </div>

    <div class="p-4 border-t border-slate-100 bg-slate-50 text-center">
      <p class="text-[10px] text-slate-400 font-medium">Data is for clinical monitoring only. Treat per protocol guidelines.</p>
    </div>
  </aside>

  <script>
    // -----------------------
    // Accessibility & small helpers (improvements)
    // -----------------------
    function makeAccessibleButton(element, onClickHandler, label) {
      if (!element) return;
      element.setAttribute('role', 'button');
      element.setAttribute('tabindex', '0');
      if (label) element.setAttribute('aria-label', label);
      element.addEventListener('click', onClickHandler);
      element.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          onClickHandler();
        }
      });
    }

    // focus trap for sidebars
    let lastFocusedElement = null;
    function trapFocus(sidebarId) {
      const sidebar = document.getElementById(sidebarId);
      if (!sidebar) return;
      const focusableElements = sidebar.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (!focusableElements.length) return;
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      function handleKey(e) {
        if (e.key === 'Tab') {
          if (e.shiftKey) { // Shift + Tab
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
        if (e.key === 'Escape') {
          if (sidebarId === 'eventSidebar') closeSidebar();
          if (sidebarId === 'labSidebar') closeLabSidebar();
        }
      }

      sidebar.addEventListener('keydown', handleKey);
      if (firstElement) firstElement.focus();
    }

    // -----------------------
    // Patient dataset (same dataset provided)
    // -----------------------
    const PATIENTS = [
      {
        ID: "PT-101", Name: "Eleanor Vance", Dx: "NSCLC (Adeno)", Stage: "IVA", Age: 62, Sex: "F", Line: 2, PS: "ECOG 1",
        History: ["CEA normalized from 12.5 to 4.2 following L2 transition.", "Primary mass reduced 50% on 2024-12-08 CT."],
        EGFR: "Exon 19 del", ALK: "Negative", KRAS: "Negative", PDL1: "75%", MSI: "MSS", TMB: "8",
        Biology: "Informational: EGFR exon 19 deletion is associated with potential sensitivity to 3rd-generation EGFR TKIs.",
        Treatments: [
          {
            line: 1, drug: "Carbo + Pemetrexed", start: "2023-03", end: "2024-05", resp: "SD", stop: "Progression",
            extended: {
              rationale: "Standard 1L systemic therapy initiated pending NGS results. Histology consistent with non-squamous disease.",
              dosing: "Carboplatin AUC 5 + Pemetrexed 500mg/m2 q3w x 4 cycles -> Maint Pemetrexed.",
              toxicity: "Course complicated by Grade 2 anemia requiring support. G1 fatigue persistent. No dose reductions.",
              outcome: "Achieved SD for 14 months. Progression marked by development of contralateral lung nodules while on maintenance."
            }
          },
          {
            line: 2, drug: "Osimertinib 80mg", start: "2024-07", end: "Current", resp: "PR", stop: "Ongoing",
            extended: {
              rationale: "Transitioned to targeted therapy following identification of EGFR Exon 19 deletion on re-biopsy.",
              dosing: "Osimertinib 80mg PO Daily.",
              toxicity: "Grade 1 dry skin and paronychia, managed with topical steroids. Grade 2 diarrhea (intermittent).",
              outcome: "Deep Partial Response (PR) confirmed on Dec 2024 scans. Primary tumor volume reduced >50%."
            }
          }
        ],
        Timeline: [
          { date: "2023-01-15", event: "Initial Presentation", status: "Baseline", cea: 1.8, detail: "Persistent cough and hemoptysis.",
            report: { findings: "Patient presented with 3-week history of non-productive cough and trace hemoptysis. ECOG 0. Auscultation reveals diminished breath sounds in RUL.", impression: "Suspicion of pulmonary malignancy vs tuberculosis. CXR confirms opacity.", plan: "Referral to Pulmonology for CT Chest and bronchoscopy." } },
          { date: "2023-03-12", event: "Diagnosis", status: "Baseline", cea: 2.5, detail: "Initial T2aN1M0. Adeno confirmed.",
            report: { findings: "CT Chest: 3.2cm spiculated mass RUL. 1.1cm Hilar lymph node. No distant mets. Biopsy: Adenocarcinoma, TTF-1 positive.", impression: "Stage IIIA (T2a N1 M0) NSCLC. Unresectable due to hilar involvement.", plan: "Initiate systemic chemotherapy (Carboplatin/Pemetrexed). Send NGS panel." } },
          { date: "2023-09-20", event: "Interim Scan", status: "SD", cea: 3.1, detail: "Stable disease on Chemotherapy.",
            report: { findings: "Primary mass stable at 3.1cm (Prev 3.2cm). Hilar node stable. No new pulmonary nodules. Hepatic parenchyma clear.", impression: "Stable Disease (SD) per RECIST 1.1.", plan: "Continue maintenance Pemetrexed. Monitor renal function." } },
          { date: "2024-05-10", event: "Progression", status: "PD", cea: 12.5, detail: "New contralateral lung nodules.",
            report: { findings: "Interval development of 3 new solid nodules in Left Lower Lobe (largest 9mm). Primary RUL mass increased to 4.2cm. Mild pleural effusion.", impression: "Radiological Progression (PD). Conversion to Stage IVA.", plan: "Discontinue Chemo. Re-biopsy for resistance mechanisms. Liquid biopsy sent." } },
          { date: "2024-07-01", event: "Therapy Switch", status: "Baseline", cea: 10.8, detail: "Initiated Osimertinib.",
            report: { findings: "NGS confirms EGFR Exon 19 Deletion (Sensitizing). T790M Negative. PD-L1 75%.", impression: "Targetable driver mutation identified. Candidate for 3rd gen TKI.", plan: "Start Osimertinib 80mg QD. Monitor for QTc prolongation and diarrhea." } },
          { date: "2024-12-08", event: "Response Scan", status: "PR", cea: 4.2, detail: "Primary mass reduced 4.2cm -> 2.1cm.",
            report: { findings: "Significant interval reduction in RUL mass (4.2cm -> 2.1cm). Contralateral nodules resolved or calcified. Effusion resolved.", impression: "Partial Response (PR). Excellent tolerance to TKI.", plan: "Continue Osimertinib. Next scan in 3 months." } }
        ],
        Labs: [
          { name: "AST", val: "58", unit: "U/L", range: "8 - 48", history: [22, 35, 45, 52, 58], trend: "up", status: "abnormal" },
          { name: "ALT", val: "72", unit: "U/L", range: "7 - 55", history: [28, 42, 55, 68, 72], trend: "up", status: "abnormal" },
          { name: "Creatinine", val: "1.0", unit: "mg/dL", range: "0.7 - 1.3", history: [0.9, 1.0, 0.9, 1.0, 1.0], trend: "stable", status: "normal" }
        ],
      },
      {
        ID: "PT-102", Name: "Arthur Morgan", Dx: "NSCLC (Squamous)", Stage: "IVB", Age: 64, Sex: "M", Line: 1, PS: "ECOG 2",
        History: ["Stable clinical state sustained for 14 months.", "Gradual decline in renal markers identified."],
        EGFR: "Negative", ALK: "Negative", KRAS: "G12C", PDL1: "90%", MSI: "MSS",
        Biology: "Informational: High PD-L1 (90%) is a biological indicator associated with Pembrolizumab response.",
        Treatments: [
          {
            line: 1, drug: "Pembrolizumab q3w", start: "2023-01", end: "Current", resp: "SD", stop: "Ongoing",
            extended: {
              rationale: "First-line monotherapy indicated for PD-L1 TPS > 50% (Patient 90%) in absence of driver mutations.",
              dosing: "Pembrolizumab 200mg IV q3w.",
              toxicity: "Grade 1 hypothyroidism (TSH elevated), started Levothyroxine. No pneumonitis or colitis.",
              outcome: "Durable Stable Disease (SD). Bone metastases sclerotic. Adrenal lesion stable."
            }
          }
        ],
        Timeline: [
          { date: "2022-11-18", event: "Diagnosis", status: "Baseline", cea: 8.0, detail: "Stage IIIA. Surgery deferred.",
            report: { findings: "4cm RUL mass abutting mediastinum. N2 disease confirmed via EBUS. Squamous histology.", impression: "Locally advanced NSCLC. Poor surgical candidate due to COPD.", plan: "Refer to Medical Oncology. Molecular testing pending." } },
          { date: "2023-01-05", event: "Metastatic Event", status: "PD", cea: 11.5, detail: "Bone/Adrenal spread.",
            report: { findings: "PET Scan: New FDG-avid lesion L3 vertebra (SUV 8.2) and Right Adrenal (3cm).", impression: "Upstaging to IVB. Symptomatic back pain consistent with L3 met.", plan: "Palliative RT to L3. Initiate Pembrolizumab (PD-L1 90%)." } },
          { date: "2023-06-12", event: "Interim Check", status: "SD", cea: 11.0, detail: "Pain resolved.",
            report: { findings: "Patient reports resolution of back pain post-RT. ECOG improving to 1. Adrenal met stable.", impression: "Clinical benefit achieved.", plan: "Continue Pembrolizumab. TSH monitoring." } },
          { date: "2024-02-20", event: "Annual Review", status: "SD", cea: 11.8, detail: "Long-term stability.",
            report: { findings: "Primary lung mass stable at 3.8cm (cavitary changes). No new bone lesions. Renal function borderline (Cr 1.1).", impression: "Durable SD. Renal decline likely comorbidity related.", plan: "Refer to Nephrology." } },
          { date: "2024-12-18", event: "Recent Review", status: "SD", cea: 12.8, detail: "Stable thoracic burden.",
            report: { findings: "Thoracic disease unchanged. Adrenal lesion stable at 2.8cm. L3 sclerosis (healing). No new active lesions.", impression: "Sustained Stable Disease (SD).", plan: "Continue Pembrolizumab. Monitor Creatinine (1.2)." } }
        ],
        Labs: [
          { name: "Creatinine", val: "1.2", unit: "mg/dL", range: "0.7 - 1.3", history: [0.9, 1.0, 1.1, 1.1, 1.2], trend: "up", status: "normal" },
          { name: "Hb", val: "9.6", unit: "g/dL", range: "13.5 - 17.5", history: [12.0, 11.2, 10.5, 10.0, 9.6], trend: "down", status: "abnormal" },
          { name: "CEA", val: "12.8", unit: "ng/mL", range: "< 3.0", history: [8.0, 11.5, 10.2, 11.0, 12.8], trend: "stable", status: "abnormal" }
        ],
      },
      {
        ID: "PT-103", Name: "Hazel Grace", Dx: "NSCLC (Adeno)", Stage: "IVB", Age: 41, Sex: "F", Line: 2, PS: "ECOG 0",
        History: ["Identified CNS progression Dec 2024.", "Lungs remain radiologically stable."],
        ALK: "Positive", EGFR: "Negative", KRAS: "Negative", PDL1: "10%",
        Biology: "Informational: ALK rearrangement is a biological target for CNS-penetrant TKIs like Alectinib.",
        Treatments: [
          {
            line: 1, drug: "Crizotinib", start: "2021-08", end: "2024-02", resp: "PR", stop: "CNS Progression",
            extended: {
              rationale: "First-generation ALK inhibitor initiated at diagnosis of metastatic disease.",
              dosing: "Crizotinib 250mg BID.",
              toxicity: "Visual disturbances (trails of light) noted initially, resolved. G1 Edema.",
              outcome: "Good systemic control for 2.5 years. Failure isolated to CNS (brain mets) due to poor BBB penetration."
            }
          },
          {
            line: 2, drug: "Alectinib 600mg BID", start: "2024-03", end: "Current", resp: "PD", stop: "Ongoing",
            extended: {
              rationale: "Second-generation ALK TKI chosen for superior CNS penetration following brain relapse.",
              dosing: "Alectinib 600mg BID with food.",
              toxicity: "Well tolerated. Mild myalgia (G1) and constipation.",
              outcome: "Initially cleared CNS disease. Recent breakthrough (Jan 2025) with new cerebellar lesion despite therapy."
            }
          }
        ],
        Timeline: [
          { date: "2021-08-04", event: "Diagnosis", status: "Baseline", cea: 1.2, detail: "Early stage IA adeno.",
            report: { findings: "Incidental 1.2cm nodule RLL. Resected. ALK+ confirmed on IHC and FISH.", impression: "Stage IA Adenocarcinoma. Margins negative.", plan: "Surveillance. No adjuvant therapy indicated." } },
          { date: "2022-08-04", event: "Surveillance", status: "CR", cea: 1.1, detail: "One year NED.",
            report: { findings: "CT Chest/Abd: No evidence of disease. Patient asymptomatic.", impression: "Disease-free interval > 12 months.", plan: "Continue annual surveillance." } },
          { date: "2024-03-01", event: "Recurrence", status: "PD", cea: 3.5, detail: "Distal lung/brain spread.",
            report: { findings: "MRI Brain: 2 parietal lesions (1.1cm, 0.9cm) with edema. CT Chest: Multiple miliary nodules.", impression: "Systemic and CNS relapse.", plan: "Start Alectinib (CNS penetrant). Defer WBRT." } },
          { date: "2024-06-15", event: "Response", status: "PR", cea: 2.1, detail: "CNS lesions regressed.",
            report: { findings: "MRI Brain: Parietal lesions reduced to <4mm calcifications. Lung nodules stable/smaller.", impression: "Excellent intracranial response to Alectinib.", plan: "Continue current TKI dosage." } },
          { date: "2025-01-10", event: "Progression", status: "PD", cea: 6.1, detail: "New 0.8cm brain lesion.",
            report: { findings: "MRI Brain: New 8mm cerebellar lesion. Previous parietal lesions calcified. Extracranial disease stable.", impression: "Isolated CNS Progression (Oligoprogression).", plan: "Refer for Stereotactic Radiosurgery (SRS). Continue Alectinib." } }
        ],
        Labs: [
          { name: "CEA", val: "6.1", unit: "ng/mL", range: "< 3.0", history: [1.2, 1.1, 3.5, 2.1, 6.1], trend: "up", status: "abnormal" },
          { name: "WBC", val: "5.2", unit: "10^3/uL", range: "4.5 - 11.0", history: [4.8, 5.0, 5.1, 5.0, 5.2], trend: "stable", status: "normal" },
          { name: "ALT", val: "28", unit: "U/L", range: "7 - 55", history: [22, 25, 30, 26, 28], trend: "stable", status: "normal" }
        ],
      }
      // (rest of PATIENTS truncated for brevity in this file snippet - in your repo you have full dataset)
    ];

    // -----------------------
    // App state
    // -----------------------
    let selectedPt = PATIENTS[0];
    let charts = [];
    let sidebarChartInstance = null;
    let labChartInstance = null;

    // -----------------------
    // Utilities
    // -----------------------
    function statusClass(status) {
      if (!status) return 'bg-baseline';
      const s = status.toString().toLowerCase();
      const map = {
        'pd': 'bg-pd', 'progression': 'bg-pd',
        'pr': 'bg-pr', 'partial response': 'bg-pr',
        'sd': 'bg-sd', 'stable disease': 'bg-sd',
        'cr': 'bg-cr', 'complete response': 'bg-cr',
        'baseline': 'bg-baseline'
      };
      return map[s] || 'bg-baseline';
    }

    function parseRange(rangeStr) {
      if (!rangeStr) return null;
      if (rangeStr.toLowerCase() === 'missing') return null;
      const clean = rangeStr.replace(/[<>]/g, '').trim();
      if (clean.includes('-')) {
        const parts = clean.split('-').map(s => parseFloat(s.trim()));
        return { min: parts[0], max: parts[1] };
      }
      if (rangeStr.includes('<')) return { min: 0, max: parseFloat(clean) };
      return null;
    }

    function getDuration(start, end) {
      const startDate = new Date(start + "-01");
      const endDate = end === "Current" ? new Date() : new Date(end + "-01");
      let months = (endDate.getFullYear() - startDate.getFullYear()) * 12;
      months -= startDate.getMonth();
      months += endDate.getMonth();
      months = months <= 0 ? 0 : months;
      return `${months} months`;
    }

    // -----------------------
    // ICD-10 integration (existing)
    // -----------------------
    async function fetchICD10(dxString) {
      const displayEl = document.getElementById('icd10-display');
      if (!displayEl) return;
      displayEl.innerHTML = '<span class="text-slate-400 animate-pulse">Fetching ICD-10...</span>';
      let searchTerm = dxString.split('(')[0].trim();
      const map = {
        'NSCLC': 'Malignant neoplasm of lung',
        'Breast': 'Malignant neoplasm of breast',
        'Colorectal': 'Malignant neoplasm of colon'
      };
      if (map[searchTerm]) searchTerm = map[searchTerm];

      try {
        const response = await fetch(`https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms=${encodeURIComponent(searchTerm)}&maxList=1`);
        const data = await response.json();
        if (data[3] && data[3].length > 0) {
          const code = data[3][0][0];
          const desc = data[3][0][1];
          displayEl.innerHTML = `
            <div class="flex items-center gap-1.5 mt-1">
              <span class="bg-blue-100 text-blue-700 border border-blue-200 text-[9px] font-black px-1.5 py-0.5 rounded">ICD-10</span>
              <span class="text-xs font-bold text-slate-600" title="${desc}">${code}</span>
            </div>
          `;
        } else {
          displayEl.innerHTML = '<span class="text-[10px] text-slate-400 italic">Code not found</span>';
        }
      } catch (error) {
        console.error("ICD API Error:", error);
        displayEl.innerHTML = '<span class="text-[10px] text-red-300">Connection Failed</span>';
      }
    }

    // -----------------------
    // SNOMED integration scaffold (configurable)
    // -----------------------
    const SNOMED_CONFIG = {
      SNOMED_API_URL: '', // configure in serverless env if required
      SNOMED_API_KEY: ''
    };

    async function fetchSNOMED(term) {
      const displayEl = document.getElementById('snomed-display');
      if (!displayEl) return;
      displayEl.innerHTML = '<span class="text-slate-400 animate-pulse">Looking up SNOMED...</span>';
      const searchTerm = term.split('(')[0].trim();

      try {
        if (SNOMED_CONFIG.SNOMED_API_URL) {
          const base = SNOMED_CONFIG.SNOMED_API_URL.replace(/\/$/, '');
          const url = `${base}/concepts?term=${encodeURIComponent(searchTerm)}&limit=1`;
          const headers = { 'Accept': 'application/json' };
          if (SNOMED_CONFIG.SNOMED_API_KEY) headers['Authorization'] = `Bearer ${SNOMED_CONFIG.SNOMED_API_KEY}`;
          const resp = await fetch(url, { headers });
          if (!resp.ok) throw new Error('SNOMED lookup failed');
          const json = await resp.json();
          const top = (json.items && json.items[0]) || (json.entry && json.entry[0] && json.entry[0].resource) || null;
          if (top) {
            const id = top.conceptId || top.id || (top.code && top.code.coding && top.code.coding[0] && top.code.coding[0].code) || 'n/a';
            const desc = top.term || top.fsn || (top.display && top.display[0]) || searchTerm;
            displayEl.innerHTML = `<div class="flex items-center gap-1.5 mt-1"><span class="bg-emerald-100 text-emerald-700 border border-emerald-200 text-[9px] font-black px-1.5 py-0.5 rounded">SNOMED</span><span class="text-xs font-bold text-slate-600">${id}</span><span class="text-xs text-slate-400 ml-2">${desc}</span></div>`;
            return;
          }
        }

        const fallbackUrl = `https://browser.ihtsdotools.org/snowstorm/snomed-ct/v3/concepts?term=${encodeURIComponent(searchTerm)}&limit=1`;
        const fallbackResp = await fetch(fallbackUrl);
        if (fallbackResp.ok) {
          const fallbackJson = await fallbackResp.json();
          const it = fallbackJson.items && fallbackJson.items[0];
          if (it) {
            const id = it.conceptId || it.id || 'n/a';
            const desc = it.fsn || it.term || searchTerm;
            displayEl.innerHTML = `<div class="flex items-center gap-1.5 mt-1"><span class="bg-emerald-100 text-emerald-700 border border-emerald-200 text-[9px] font-black px-1.5 py-0.5 rounded">SNOMED</span><span class="text-xs font-bold text-slate-600">${id}</span><span class="text-xs text-slate-400 ml-2">${desc}</span></div>`;
            return;
          }
        }

        // fallback message (clearer to user)
        displayEl.innerHTML = '<span class="text-[10px] text-slate-400 italic">SNOMED lookup not available (configure API or enable CORS)</span>';
      } catch (err) {
        console.warn('SNOMED lookup error', err);
        displayEl.innerHTML = '<span class="text-[10px] text-slate-400 italic">SNOMED lookup failed or blocked (CORS/licensing)</span>';
      }
    }

    // -----------------------
    // Rendering functions
    // -----------------------
    function clearCharts() {
      charts.forEach(c => { try { c.destroy(); } catch(e){} });
      charts = [];
      if (sidebarChartInstance) { try { sidebarChartInstance.destroy(); } catch(e){} sidebarChartInstance = null; }
      if (labChartInstance) { try { labChartInstance.destroy(); } catch(e){} labChartInstance = null; }
    }

    // -----------------------
    // COMPACT renderHeader (STACKED) - replace previous long inline header
    // -----------------------
    function renderHeader() {
      const header = document.getElementById('topSummary');
      if (!header) return;

      // Build a compact stacked left column with clear labels
      header.innerHTML = `
        <div class="flex flex-col gap-2">
          <div>
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Patient</span>
            <div class="flex items-baseline gap-2">
              <span class="text-lg font-bold text-indigo-900">${selectedPt.Name}</span>
              <span class="text-xs text-slate-400 font-medium">(${selectedPt.ID})</span>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-3">
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Demographics</div>
            <div class="text-sm font-semibold text-slate-700">${selectedPt.Age}Y • ${selectedPt.Sex} • ${selectedPt.PS || ''}</div>
          </div>

          <div class="flex items-center gap-3">
            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Diagnosis</div>
            <div class="text-sm font-bold text-indigo-700">${selectedPt.Dx}</div>
          </div>

          <div class="text-sm text-slate-600 leading-relaxed mt-1">
            ${selectedPt.History && selectedPt.History.length ? `<ul class="list-disc pl-4 text-[13px]">${selectedPt.History.slice(0,2).map(h=>`<li>${h}</li>`).join('')}</ul>` : ''}
          </div>
        </div>
      `;

      const updatesBox = document.getElementById('clinicalUpdates');
      if (updatesBox) {
        updatesBox.innerHTML = `
          <h3 class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-2">Key Clinical Changes</h3>
          <div class="space-y-1">
            ${selectedPt.History && selectedPt.History.length ? selectedPt.History.map(h => `<div class="text-sm font-bold text-indigo-900">• ${h}</div>`).join('') : '<div class="text-sm text-slate-500">No recent changes</div>'}
          </div>
        `;
      }

      // update code + snomed lookup area
      fetchICD10(selectedPt.Dx);
      fetchSNOMED(selectedPt.Dx);
    }

    function renderTimelinePanel() {
      const panel = document.getElementById('panel-timeline');
      panel.innerHTML = `
        <section class="clinical-card p-6">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
              <i data-lucide="line-chart" class="w-4 h-4"></i> Longitudinal Disease Course
            </h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-10 gap-8">
            <div id="timelineContainer" class="md:col-span-4 space-y-6 relative ml-2" tabindex="0" aria-label="Timeline list"></div>
            <div class="md:col-span-6 border-l border-slate-50 pl-4 h-64">
              <canvas id="biomarkerChart" aria-label="Biomarker trend chart"></canvas>
            </div>
          </div>
        </section>
      `;
      renderTimeline();
    }

    function renderOverviewPanel() {
      const panel = document.getElementById('panel-overview');
      panel.innerHTML = `
        <div class="grid grid-cols-12 gap-8">
          <div class="col-span-12 lg:col-span-8 space-y-8">
            <section class="clinical-card p-6">
              <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6 flex items-center gap-2">
                <i data-lucide="database" class="w-4 h-4"></i> Treatment History (By Line)
              </h2>
              <div id="treatmentLines" class="space-y-3"></div>
            </section>

            <section class="clinical-card p-6">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                  <i data-lucide="activity" class="w-4 h-4"></i> Labs & Safety Monitor
                </h2>
                <span class="text-[9px] font-medium text-slate-400 italic bg-slate-50 px-2 py-1 rounded border border-slate-100">
                  For monitoring trends only. Not for Rx decisions.
                </span>
              </div>
              <div id="labsGrid"></div>
            </section>
          </div>

          <aside class="col-span-12 lg:col-span-4 space-y-8">
            <section class="ai-panel p-6 border-t-2 border-t-indigo-500">
              <h2 class="text-xs font-black text-indigo-900 uppercase tracking-widest mb-5 flex items-center gap-2">
                <i data-lucide="sparkles" class="w-3.5 h-3.5 text-indigo-600"></i> AI-Assisted Clinical Summary (For Review Only)
              </h2>
              <ul id="aiSummaryPoints" class="space-y-4 text-[12px] text-slate-700 font-medium" aria-live="polite"></ul>

              <div class="next-steps-box p-4 mt-6">
                <div class="flex items-center gap-2 mb-2">
                  <i data-lucide="arrow-right-circle" class="w-3.5 h-3.5 text-indigo-600"></i>
                  <span class="text-[10px] font-black text-indigo-900 uppercase tracking-widest">Clinical Considerations (Next Steps)</span>
                </div>
                <ul id="aiNextSteps" class="space-y-2 text-[11px] text-indigo-800 font-semibold leading-snug list-disc pl-4"></ul>
              </div>
            </section>

            <section class="clinical-card p-6" aria-labelledby="molecularHeading">
              <h2 id="molecularHeading" class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-5 flex items-center gap-2">
                <i data-lucide="dna" class="w-4 h-4"></i> Molecular Profile
              </h2>
              <div id="molecularList" class="space-y-4"></div>
            </section>
          </aside>
        </div>
      `;
      renderTreatments();
      renderLabs();
      renderAISummary();
      renderMolecular();
    }

    function renderMolecularPanel() {
      const panel = document.getElementById('panel-molecular');
      panel.innerHTML = `
        <section class="clinical-card p-6">
          <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Molecular & Biomarker Detail</h2>
          <div id="molecularListFull"></div>
        </section>
      `;
      const el = document.getElementById('molecularListFull');
      el.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="clinical-card p-4">
            <h3 class="text-sm font-bold mb-2">Key markers</h3>
            <div id="molecularListCompact"></div>
          </div>
          <div class="clinical-card p-4">
            <h3 class="text-sm font-bold mb-2">Biology & Notes</h3>
            <div class="text-sm text-slate-700 italic">${selectedPt.Biology}</div>
          </div>
        </div>
      `;
      renderMolecular();
    }

    function renderLabsPanel() {
      const panel = document.getElementById('panel-labs');
      panel.innerHTML = `<section class="clinical-card p-6"><h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Full Lab Panel</h2><div id="labsListFull"></div></section>`;
      const lf = document.getElementById('labsListFull');
      lf.innerHTML = `<div class="grid md:grid-cols-2 gap-4">${(selectedPt.Labs || []).map(l => `
        <div class="p-3 border rounded">
          <div class="text-xs text-slate-500 font-bold">${l.name}</div>
          <div class="text-lg font-black">${l.val} <span class="text-sm text-slate-400 font-medium">${l.unit || ''}</span></div>
          <div class="text-sm text-slate-500 mt-2">Range: ${l.range || 'n/a'} | Trend: ${l.trend || 'n/a'}</div>
        </div>
      `).join('')}</div>`;
    }

    // timeline & biomarker chart
    function renderTimeline() {
      const list = document.getElementById('timelineContainer');
      if (!list) return;
      list.innerHTML = `<div class="timeline-line"></div>`;
      if (selectedPt.Timeline && selectedPt.Timeline.length) {
        selectedPt.Timeline.sort((a,b) => new Date(a.date) - new Date(b.date));
      }

      (selectedPt.Timeline || []).forEach((t, i) => {
        const item = document.createElement('div');
        item.className = "relative pl-10 pb-6 group cursor-pointer transition-all duration-200 hover:translate-x-1 outline-none focus:translate-x-1";
        item.onclick = () => openModal(t);
        makeAccessibleButton(item, () => openModal(t), `View details for ${t.event} on ${t.date}`);

        const badgeClass = statusClass(t.status);
        item.innerHTML = `
          <div class="timeline-dot ${i === selectedPt.Timeline.length - 1 ? 'active shadow-[0_0_0_4px_#e0e7ff]' : 'group-hover:border-indigo-500 group-hover:bg-indigo-50'} absolute left-0 top-1 transition-colors" aria-hidden="true"></div>
          <div class="flex items-center gap-2 mb-1">
            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-tight group-hover:text-indigo-600">${t.date}</span>
            <span class="status-badge ${badgeClass}">${t.status}</span>
          </div>
          <div class="text-xs font-bold text-slate-800 group-hover:text-indigo-700">${t.event} <span class="text-[10px] text-indigo-400 opacity-0 group-hover:opacity-100 ml-1">(View Report)</span></div>
          <div class="text-[10px] text-slate-400 mt-1 leading-relaxed">${t.detail}</div>
        `;
        list.appendChild(item);
      });

      renderBiomarkerChart();
    }

    function renderBiomarkerChart() {
      const canvas = document.getElementById('biomarkerChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      try { ctx.clearRect(0,0,canvas.width,canvas.height); } catch(e){}

      const plotData = (selectedPt.Timeline || []).filter(t => t.cea !== undefined);
      const markerNames = (selectedPt.Labs || []).map(l => l.name.toLowerCase());
      const yLabel = markerNames.includes('psa') ? "PSA (ng/mL)" :
                      markerNames.some(n => /cea|ca 15|ca 27|ca 125|afp/i.test(n)) ? "Tumor marker (ng/mL)" :
                      "Biomarker Level (units)";

      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(79, 70, 229, 0.2)');
      gradient.addColorStop(1, 'rgba(79, 70, 229, 0.0)');

      const dataset = {
        label: yLabel,
        data: plotData.map(t => t.cea),
        borderColor: '#4f46e5',
        backgroundColor: gradient,
        borderWidth: 2.5,
        pointBackgroundColor: '#ffffff',
        pointBorderColor: '#4f46e5',
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6,
        fill: true,
        tension: 0.4
      };

      try {
        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: plotData.map(t => t.date),
            datasets: [dataset]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } },
              tooltip: { backgroundColor: 'rgba(30, 41, 59, 0.9)', padding: 10, titleFont: { size: 11, weight: 'bold' }, bodyFont: { size: 11 } }
            },
            scales: {
              y: { beginAtZero: true, grid: { color: '#f1f3f5', borderDash: [5,5] }, ticks: { font: { size: 10, weight: '600' }, color: '#64748b' }, title: { display: true, text: yLabel, font: { size: 10, weight: 'bold' }, color: '#94a3b8' } },
              x: { grid: { display: false }, ticks: { font: { size: 9, weight: '600' }, color: '#64748b', maxRotation: 45, minRotation: 45 } }
            }
          }
        });
        charts.push(chart);
        setTimeout(()=> { try { chart.resize(); } catch(e){} }, 50);
      } catch(e) { console.error('chart error', e); }
    }

    // open modal (sidebar) -> show details and trap focus
    function openModal(data) {
      lastFocusedElement = document.activeElement;
      document.getElementById('sidebarDate').innerText = data.date;
      document.getElementById('sidebarEvent').innerText = data.event;
      document.getElementById('sidebarBadge').innerHTML = `<span class="status-badge ${statusClass(data.status)}">${data.status}</span>`;
      document.getElementById('sidebarContent').innerHTML = `
        <div>
          <h4 class="text-sm font-bold text-slate-700 mb-1">Findings</h4>
          <div class="text-sm text-slate-600">${data.report && data.report.findings ? data.report.findings : 'No detailed findings'}</div>
        </div>
        <div>
          <h4 class="text-sm font-bold text-slate-700 mb-1">Impression</h4>
          <div class="text-sm text-slate-600">${data.report && data.report.impression ? data.report.impression : '—'}</div>
        </div>
        <div>
          <h4 class="text-sm font-bold text-slate-700 mb-1">Plan</h4>
          <div class="text-sm text-slate-600">${data.report && data.report.plan ? data.report.plan : '—'}</div>
        </div>
      `;

      const sidebar = document.getElementById('eventSidebar');
      const backdrop = document.getElementById('sidebarBackdrop');
      backdrop.classList.remove('hidden');
      setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
      sidebar.classList.remove('translate-x-full');
      sidebar.setAttribute('aria-hidden', 'false');
      try { lucide.createIcons(); } catch(e){}
      setTimeout(()=> trapFocus('eventSidebar'), 100);
    }

    function closeSidebar() {
      const sidebar = document.getElementById('eventSidebar');
      const backdrop = document.getElementById('sidebarBackdrop');
      sidebar.classList.add('translate-x-full');
      backdrop.classList.add('opacity-0');
      setTimeout(() => backdrop.classList.add('hidden'), 300);
      sidebar.setAttribute('aria-hidden', 'true');
      if (lastFocusedElement) lastFocusedElement.focus();
    }

    // Treatments rendering (accordion) with aria-expanded
    function toggleTreatment(index) {
      const content = document.getElementById(`tx-detail-${index}`);
      const toggleBtn = document.getElementById(`tx-toggle-${index}`);
      const icon = document.getElementById(`tx-icon-${index}`);
      if (!content || !toggleBtn) return;
      const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
      if (!expanded) {
        content.classList.remove('hidden'); content.classList.add('animate-open');
        toggleBtn.setAttribute('aria-expanded', 'true'); if (icon) icon.style.transform='rotate(180deg)';
      } else {
        content.classList.add('hidden'); content.classList.remove('animate-open'); toggleBtn.setAttribute('aria-expanded', 'false'); if (icon) icon.style.transform='rotate(0deg)';
      }
    }

    function renderTreatments() {
      const container = document.getElementById('treatmentLines');
      if (!container) return;
      container.innerHTML = "";
      (selectedPt.Treatments || []).forEach((t, index) => {
        let theme = { border: 'border-slate-200', bg: 'bg-slate-50', text: 'text-slate-600', badge: 'bg-slate-100 text-slate-600' };
        const stopReason = (t.stop || '').toLowerCase();
        const response = (t.resp || '').toLowerCase();
        if (stopReason.includes('ongoing')) theme = { border: 'border-emerald-500', bg: 'bg-emerald-50', text: 'text-emerald-700', badge: 'bg-emerald-100 text-emerald-800' };
        else if (stopReason.includes('progression') || stopReason.includes('failure')) theme = { border: 'border-red-400', bg: 'bg-red-50', text: 'text-red-700', badge: 'bg-red-100 text-red-800' };
        else if (stopReason.includes('toxicity')) theme = { border: 'border-amber-400', bg: 'bg-amber-50', text: 'text-amber-700', badge: 'bg-amber-100 text-amber-800' };
        else if (response === 'cr' || response === 'pr') theme = { border: 'border-indigo-300', bg: 'bg-indigo-50', text: 'text-indigo-700', badge: 'bg-indigo-100 text-indigo-800' };

        const card = document.createElement('div');
        card.className = "mb-4 rounded border border-slate-200 overflow-hidden shadow-sm hover:shadow-md transition-shadow";
        card.innerHTML = `
          <div id="tx-toggle-${index}" role="button" aria-expanded="false" aria-controls="tx-detail-${index}" onclick="toggleTreatment(${index})" class="relative flex flex-col md:flex-row gap-4 p-4 cursor-pointer bg-white hover:bg-slate-50/50 border-l-4 ${theme.border} transition-colors">
            <div class="flex flex-col items-center justify-center shrink-0 md:border-r border-slate-100 md:pr-4 min-w-[60px]">
              <span class="text-[9px] font-black uppercase tracking-widest text-slate-400 mb-1">Line</span>
              <div class="text-xl font-black ${theme.text}">${t.line}</div>
            </div>

            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
              <div>
                <h4 class="text-sm font-bold text-slate-900 flex items-center gap-2">${t.drug} ${t.end === "Current" ? '<span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-emerald-100 text-emerald-700 uppercase tracking-wide">Active</span>' : ''}</h4>
                <div class="flex items-center gap-2 mt-1 text-[11px] font-medium text-slate-500">
                  <span>${t.start} — ${t.end}</span>
                  <span class="text-slate-300">|</span>
                  <span class="text-slate-700 font-semibold">${getDuration(t.start, t.end)}</span>
                </div>
              </div>

              <div class="flex items-center justify-between md:justify-end md:gap-8">
                <div>
                  <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block mb-0.5">Response</span>
                  <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold border border-slate-100 bg-white text-slate-700">${t.resp}</span>
                </div>
                <div class="text-right">
                  <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block mb-0.5">Outcome</span>
                  <span class="text-[11px] font-bold ${theme.text}">${t.stop}</span>
                </div>
                <i id="tx-icon-${index}" data-lucide="chevron-down" class="w-5 h-5 text-slate-300 transition-transform duration-300"></i>
              </div>
            </div>
          </div>

          <div id="tx-detail-${index}" class="hidden bg-slate-50 border-t border-slate-100 p-5">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-200 pb-1">Context & Rationale</h5>
                <p class="text-xs font-medium text-slate-700 leading-relaxed">${t.extended.rationale}</p>
                <div class="mt-3">
                  <span class="text-[9px] font-bold text-slate-400 uppercase">Dosing Regimen:</span>
                  <p class="text-xs text-slate-600 font-mono mt-0.5">${t.extended.dosing}</p>
                </div>
              </div>

              <div>
                <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-200 pb-1">Safety Profile</h5>
                <p class="text-xs font-medium text-slate-700 leading-relaxed">${t.extended.toxicity}</p>
              </div>

              <div>
                <h5 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-200 pb-1">Clinical Outcome</h5>
                <div class="bg-white p-3 rounded border border-slate-200">
                  <p class="text-xs font-bold text-slate-800 leading-relaxed">${t.extended.outcome}</p>
                </div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
      try { lucide.createIcons(); } catch(e) {}
    }

    function renderLabs() {
      const container = document.getElementById('labsGrid');
      if (!container) return;
      container.innerHTML = "";
      container.className = "grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-8";

      const categories = {
        'Hematology': ['Hb', 'WBC', 'Plt', 'Platelets', 'Neutrophils', 'Lymphocytes', 'Hgb'],
        'Liver Function': ['AST', 'ALT', 'Bilirubin', 'Albumin', 'ALP'],
        'Renal & Metabolic': ['Creatinine', 'Cr', 'eGFR', 'Sodium', 'Potassium', 'Electrolytes'],
        'Tumor Markers': ['CEA', 'PSA', 'CA 15-3', 'CA 27-29', 'CA 125', 'AFP']
      };

      Object.entries(categories).forEach(([catName, keywords]) => {
        const catLabs = (selectedPt.Labs || []).filter(l => keywords.some(k => l.name.includes(k) || l.name === k));
        if (catLabs.length === 0) return;

        const groupDiv = document.createElement('div');
        groupDiv.className = "flex flex-col gap-3";
        groupDiv.innerHTML = `
          <div class="flex items-center gap-2 border-b border-slate-100 pb-2 mb-1">
            <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
            <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-widest">${catName}</h3>
          </div>
          <div class="grid grid-cols-2 gap-3">
            ${catLabs.map(l => {
              const realIndex = selectedPt.Labs.indexOf(l);
              const isAbnormal = l.status === 'abnormal';
              const isMissing = l.status === 'missing';
              let border = isAbnormal ? 'border-red-200' : 'border-slate-200';
              let bg = isAbnormal ? 'bg-red-50/50' : 'bg-white';
              let text = isAbnormal ? 'text-red-700' : 'text-slate-700';
              let icon = l.trend === 'up' ? 'arrow-up-right' : l.trend === 'down' ? 'arrow-down-right' : 'minus';
              if (isMissing) { border = 'border-slate-100'; bg = 'bg-slate-50'; text = 'text-slate-400'; icon = 'help-circle'; }

              return `
                <div onclick="openLabSidebar(${realIndex})" role="button" tabindex="0" aria-label="Open ${l.name} details" class="relative p-3 rounded border ${border} ${bg} cursor-pointer hover:shadow-md hover:border-indigo-300 transition-all group">
                  <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase truncate">${l.name}</span>
                    <i data-lucide="${icon}" class="w-3 h-3 ${isAbnormal ? 'text-red-500' : 'text-slate-300'}"></i>
                  </div>
                  <div class="flex items-baseline gap-1">
                    <span class="text-sm font-black ${text}">${l.val}</span>
                    <span class="text-[9px] font-medium text-slate-400">${l.unit}</span>
                  </div>
                  ${isAbnormal ? '<div class="absolute bottom-1 right-1 w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>' : ''}
                </div>
              `;
            }).join('')}
          </div>
        `;
        container.appendChild(groupDiv);
      });

      try { lucide.createIcons(); } catch(e) {}
    }

    function openLabSidebar(index) {
      const l = selectedPt.Labs[index];
      if (!l) return;
      document.getElementById('labSidebarTitle').innerText = l.name;
      document.getElementById('labSidebarValue').innerText = l.val;
      document.getElementById('labSidebarUnit').innerText = l.unit || '';
      document.getElementById('labSidebarRange').innerText = l.range || 'n/a';
      const statusEl = document.getElementById('labSidebarStatus');
      const isAbnormal = l.status === 'abnormal';
      statusEl.innerHTML = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded text-[10px] font-black uppercase tracking-wide ${isAbnormal ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">${isAbnormal ? '<i data-lucide="alert-circle" class="w-3 h-3"></i> Abnormal' : '<i data-lucide="check-circle" class="w-3 h-3"></i> Normal'}</span>`;

      const sidebar = document.getElementById('labSidebar');
      const backdrop = document.getElementById('labSidebarBackdrop');
      backdrop.classList.remove('hidden');
      setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
      sidebar.classList.remove('translate-x-full');
      sidebar.setAttribute('aria-hidden', 'false');
      try { lucide.createIcons(); } catch(e) {}

      // chart
      const ctx = document.getElementById('sidebarLabChart').getContext('2d');
      if (sidebarChartInstance) sidebarChartInstance.destroy();
      const dataPoints = (l.history && l.history.length) ? l.history : [parseFloat(l.val) || 0];
      const labels = dataPoints.map((_, i) => i === dataPoints.length - 1 ? 'Current' : `Prior ${dataPoints.length - 1 - i}`);
      const rangeData = parseRange(l.range);
      const datasets = [{ label: l.name, data: dataPoints, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', borderWidth: 2.5, pointBackgroundColor: '#fff', pointBorderColor: '#4f46e5', pointRadius: 5, fill: true, tension: 0.3 }];
      if (rangeData) {
        if (rangeData.max) datasets.push({ label: 'Upper Limit', data: Array(labels.length).fill(rangeData.max), borderColor: '#f87171', borderWidth: 1.5, borderDash: [5,5], pointRadius: 0, fill: false });
        if (rangeData.min > 0) datasets.push({ label: 'Lower Limit', data: Array(labels.length).fill(rangeData.min), borderColor: '#f87171', borderWidth: 1.5, borderDash: [5,5], pointRadius: 0, fill: false });
      }
      sidebarChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: '#1e293b', titleFont: { size: 10 }, bodyFont: { size: 12, weight: 'bold' } } }, scales: { y: { grid: { color: '#f1f5f9' }, ticks: { font: { size: 10, weight: 'bold' }, color: '#64748b' } }, x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' }, color: '#94a3b8' } } } } });
      setTimeout(()=> trapFocus('labSidebar'), 100);
    }

    function closeLabSidebar() {
      const sidebar = document.getElementById('labSidebar');
      const backdrop = document.getElementById('labSidebarBackdrop');
      sidebar.classList.add('translate-x-full');
      backdrop.classList.add('opacity-0');
      setTimeout(() => backdrop.classList.add('hidden'), 300);
      sidebar.setAttribute('aria-hidden', 'true');
    }

    // AI summary and next steps
    function generateAISummary(pt) {
      const summary = [];
      const latestEvent = pt.Timeline && pt.Timeline.length ? pt.Timeline[pt.Timeline.length - 1] : null;
      if (latestEvent) summary.push(`Current disease status: ${latestEvent.status} (latest: ${latestEvent.date} — ${latestEvent.event}).`);
      else summary.push("No timeline events available to determine current disease status.");

      const activeTx = pt.Treatments ? pt.Treatments.find(t => t.end === "Current") : null;
      if (activeTx) summary.push(`On active therapy: Line ${activeTx.line} — ${activeTx.drug} (documented response: ${activeTx.resp}).`);
      else if (pt.Line !== undefined && pt.Line !== null) summary.push(`No active therapy entry found. Charted active arc: Line ${pt.Line}.`);

      if (pt.Timeline && pt.Timeline.length > 1) {
        const prev = pt.Timeline[pt.Timeline.length - 2];
        if (prev.status !== latestEvent.status) summary.push(`Trajectory note: status changed from ${prev.status} (${prev.date}) to ${latestEvent.status} (${latestEvent.date}).`);
      }

      const markerLabs = (pt.Labs || []).filter(l => /CEA|PSA|CA 15-3|CA 27-29|CA 125|AFP/i.test(l.name));
      markerLabs.forEach(lab => {
        const prevVal = (lab.history && lab.history.length > 1) ? lab.history[lab.history.length - 2] : null;
        if (lab.trend === 'up') summary.push(`${lab.name} trending up${prevVal ? ` (${prevVal} → ` : ' ('}${lab.val}).`);
        else if (lab.trend === 'down') summary.push(`${lab.name} trending down${prevVal ? ` (${prevVal} → ` : ' ('}${lab.val}).`);
        else summary.push(`${lab.name} current: ${lab.val} ${lab.unit || ''}.`);
      });

      const abnormalLabs = (pt.Labs || []).filter(l => l.status === 'abnormal');
      if (abnormalLabs.length) summary.push(`Lab abnormalities: ${abnormalLabs.map(l => l.name + ' (' + l.val + (l.unit ? ' ' + l.unit : '') + ')').join(', ')} — consider trend review.`);

      if (pt.EGFR && pt.EGFR !== 'Negative') summary.push(`Molecular: ${pt.EGFR} detected — relevant to EGFR-targeted therapies.`);
      if (pt.ALK && pt.ALK.toLowerCase() === 'positive') summary.push(`Molecular: ALK-positive disease (consider CNS penetration when applicable).`);
      if (pt.MSI && pt.MSI.toUpperCase() === 'MSI-H') summary.push(`Molecular: MSI-High — favorable for immunotherapy approaches.`);
      if (pt.PS) summary.push(`Functional status: ${pt.PS}.`);
      if (summary.length === 0) summary.push("Insufficient data to generate AI summary.");
      return summary;
    }

    function generateNextSteps(pt) {
      const steps = [];
      const latestEvent = pt.Timeline && pt.Timeline.length ? pt.Timeline[pt.Timeline.length - 1] : null;
      if (latestEvent && (latestEvent.status === 'PR' || latestEvent.status === 'SD')) steps.push("Continue surveillance imaging per routine cadence to confirm response durability.");
      else if (latestEvent && latestEvent.status === 'PD') steps.push("Reassess pattern of progression and consider restaging/imaging to define next management options.");
      const abnormalLabs = (pt.Labs || []).filter(l => l.status === 'abnormal');
      if (abnormalLabs.length) steps.push(`Trend and evaluate: ${abnormalLabs.map(l => l.name).join(', ')} for possible treatment-related toxicity or disease effect.`);
      if ((pt.ALK && pt.ALK.toLowerCase() === 'positive') && latestEvent && /brain|cns/i.test(latestEvent.event + latestEvent.detail)) steps.push("Isolated CNS progression detected — consider local CNS-directed therapy (e.g., SRS) alongside systemic strategy.");
      const missing = (pt.Labs || []).filter(l => l.status === 'missing');
      if (missing.length) steps.push(`Missing labs: ${missing.map(m => m.name).join(', ')} — obtain if possible to complete safety assessment.`);
      if (steps.length === 0) steps.push("No immediate actions identified; maintain current plan and routine monitoring.");
      return steps;
    }

    function renderAISummary() {
      const summaryPoints = generateAISummary(selectedPt);
      const nextSteps = generateNextSteps(selectedPt);
      document.getElementById('aiSummaryPoints').innerHTML = summaryPoints.map(p =>
        `<li class="flex gap-3 leading-relaxed"><i data-lucide="chevron-right" class="w-3.5 h-3.5 shrink-0 text-indigo-400 mt-0.5"></i><span>${p}</span></li>`
      ).join('');
      document.getElementById('aiNextSteps').innerHTML = nextSteps.map(s => `<li>${s}</li>`).join('');
      try { lucide.createIcons(); } catch(e) {}
    }

    function renderMolecular() {
      const container = document.getElementById('molecularList');
      const containerCompact = document.getElementById('molecularListCompact');
      if (container) {
        container.innerHTML = "";
        ['EGFR', 'ALK', 'KRAS', 'PDL1', 'MSI', 'TMB', 'ER', 'PR', 'HER2'].forEach(m => {
          if (selectedPt[m]) {
            container.innerHTML += `<div class="flex justify-between items-center py-2 border-b border-slate-50"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${m}</span><span class="text-[11px] font-bold ${selectedPt[m]!=='Negative' && selectedPt[m]!=='MSS' ? 'text-indigo-600':'text-slate-400'}">${selectedPt[m]}</span></div>`;
          }
        });
        container.innerHTML += `<div class="mt-4 p-4 bg-slate-50 text-[11px] font-medium text-slate-600 border border-slate-100 leading-relaxed italic">${selectedPt.Biology}</div>`;
      }
      if (containerCompact) {
        containerCompact.innerHTML = "";
        ['EGFR', 'ALK', 'KRAS', 'PDL1', 'MSI', 'TMB', 'ER', 'PR', 'HER2'].forEach(m => {
          if (selectedPt[m]) {
            containerCompact.innerHTML += `<div><strong>${m}</strong>: <span class="${selectedPt[m]!=='Negative' ? 'text-indigo-600':'text-slate-600'}">${selectedPt[m]}</span></div>`;
          }
        });
      }
    }

    // -----------------------
    // TABS: only overview + timeline now
    // -----------------------
    function switchTab(tab) {
      const tabs = ['overview', 'timeline'];
      tabs.forEach(t => {
        const tabBtn = document.getElementById(`tab-${t}`);
        const panel = document.getElementById(`panel-${t}`);
        if (t === tab) {
          if (tabBtn) { tabBtn.setAttribute('aria-selected','true'); tabBtn.classList.remove('border','border-slate-200'); tabBtn.classList.add('bg-indigo-600','text-white'); }
          if (panel) panel.removeAttribute('hidden');
        } else {
          if (tabBtn) { tabBtn.setAttribute('aria-selected','false'); tabBtn.classList.remove('bg-indigo-600','text-white'); tabBtn.classList.add('border','border-slate-200'); }
          if (panel) panel.setAttribute('hidden','');
        }
      });

      // Ensure content panels are rendered when switching
      if (tab === 'overview') { renderOverviewPanel(); }
      if (tab === 'timeline') { renderTimelinePanel(); }
      try { lucide.createIcons(); } catch(e) {}
    }

    // -----------------------
    // Export PDF (html2canvas + jsPDF)
    // -----------------------
    async function exportPatientSummaryPDF() {
      const wrapper = document.createElement('div');
      // Gather content: header + overview panel snapshot
      const top = document.getElementById('topSummary').cloneNode(true);
      const updates = document.getElementById('clinicalUpdates').cloneNode(true);
      const overview = document.getElementById('panel-overview') ? document.getElementById('panel-overview').cloneNode(true) : document.getElementById('panel-timeline').cloneNode(true);
      // Minimal styling to ensure readable PDF
      wrapper.style.width = '1000px';
      wrapper.style.padding = '24px';
      wrapper.style.background = '#fff';
      wrapper.appendChild(updates);
      wrapper.appendChild(top);
      wrapper.appendChild(overview);

      document.body.appendChild(wrapper);
      try {
        const canvas = await html2canvas(wrapper, { scale: 2, useCORS: true, allowTaint: true });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
        const margin = 40;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pageWidth - margin * 2;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
        const name = `${selectedPt.ID}_summary.pdf`;
        pdf.save(name);
      } catch (err) {
        console.error('PDF export failed', err);
        alert('PDF export failed. Check console for errors.');
      } finally {
        document.body.removeChild(wrapper);
      }
    }

    // -----------------------
    // Small utility actions
    // -----------------------
    function copyPatientLink() {
      const link = `${location.origin}${location.pathname}?patient=${selectedPt.ID}`;
      navigator.clipboard.writeText(link).then(()=> alert('Patient link copied to clipboard')).catch(()=> alert('Copy failed'));
    }
    function openShareModal() { alert('Share modal placeholder — integrate with your sharing endpoint.'); }

    // NEW utility: open patient in new browser tab (allows multiple patient tabs)
    function openPatientInNewTab() {
      try {
        const link = `${location.origin}${location.pathname}?patient=${encodeURIComponent(selectedPt.ID)}`;
        window.open(link, '_blank', 'noopener');
      } catch (e) {
        console.error('Open in new tab failed', e);
        alert('Unable to open patient in a new tab.');
      }
    }

    // -----------------------
    // Load patient and rendering orchestration
    // -----------------------
    function loadPatient() {
      const selector = document.getElementById('patientSelect');
      const found = PATIENTS.find(p => p.ID === selector.value);
      if (found) selectedPt = found;
      renderDashboard();
    }

    function renderDashboard() {
      clearCharts();
      renderHeader();
      // default to overview
      renderOverviewPanel();
      // Keep the active tab selected (if previously changed)
      const selectedTab = Array.from(['overview','timeline']).find(t => document.getElementById(`tab-${t}`) && document.getElementById(`tab-${t}`).getAttribute('aria-selected') === 'true') || 'overview';
      switchTab(selectedTab);
      try { lucide.createIcons(); } catch(e){}
    }

    // -----------------------
    // Init
    // -----------------------
    function init() {
      const selector = document.getElementById('patientSelect');
      PATIENTS.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.ID; opt.innerText = `${p.ID} — ${p.Name}`; selector.appendChild(opt);
      });
      selector.value = PATIENTS[0].ID;
      selectedPt = PATIENTS[0];

      // If URL has ?patient=PT-... then select that patient
      try {
        const params = new URLSearchParams(window.location.search);
        const pid = params.get('patient');
        if (pid) {
          const found = PATIENTS.find(x=>x.ID === pid);
          if (found) { selector.value = found.ID; selectedPt = found; }
        }
      } catch(e) {}

      renderDashboard();

      // ensure charts resize on window resize
      window.addEventListener('resize', () => { charts.forEach(c => { try { c.resize(); } catch(e){} }); if (sidebarChartInstance) try{sidebarChartInstance.resize()}catch(e){}; if (labChartInstance) try{labChartInstance.resize()}catch(e){}; });
    }

    window.onload = init;
  </script>
</body>
</html>
