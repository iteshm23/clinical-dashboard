<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clinical Dashboard | RISA Labs — Vercel</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Icons + Chart.js -->
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<!-- PDF export libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  body { font-family: 'Inter', sans-serif; background: #fcfcfd; color: #0f172a; }
  :focus-visible { outline: 3px solid rgba(79,70,229,0.28); outline-offset: 2px; border-radius: 4px; }
  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap; border: 0; }
  .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; border: 1px solid transparent; display:inline-block;}
  .bg-pd { background-color: #fff1f2; color: #9f1239; border-color: #fecdd3; }
  .bg-pr { background-color: #f0fdf4; color: #166534; border-color: #dcfce7; }
  .bg-sd { background-color: #eff6ff; color: #1e40af; border-color: #dbeafe; }
  .bg-cr { background-color: #faf5ff; color: #6b21a8; border-color: #f3e8ff; }
  .bg-baseline { background-color: #f8fafc; color: #475569; border-color: #e2e8f0; }
  .timeline-line { position: absolute; left: 7px; top: 0; bottom: 0; width: 1px; background: #e2e8f0; }
</style>
</head>
<body class="p-6 lg:p-8 max-w-[1400px] mx-auto">

<a href="#mainContent" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:bg-indigo-600 focus:text-white focus:p-4 focus:z-50 focus:rounded focus:font-bold">Skip to main content</a>

<header class="mb-6 border-b pb-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-lg font-bold">Clinical Review Interface — RISA Labs</h1>
      <div class="text-xs text-slate-500 mt-1">Proof-of-concept — Read-only synthetic data</div>
    </div>
    <div class="flex items-center gap-4">
      <label for="patientSelect" class="text-sm font-semibold">Select patient</label>
      <select id="patientSelect" class="p-2 border rounded-md" aria-label="Select patient"></select>
      <button id="exportBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md" aria-label="Export PDF summary">Export PDF</button>
    </div>
  </div>
</header>

<main id="mainContent" role="main" class="space-y-6">
  <div id="clinicalUpdates" class="p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-r-sm shadow-sm" aria-live="polite" aria-atomic="true"></div>

  <section class="p-4 bg-white border rounded-md" role="region" aria-label="Patient summary">
    <div class="flex items-start justify-between gap-4">
      <div id="topSummary" class="flex-1"></div>
      <div class="w-[260px]">
        <div class="p-3 border rounded-md mb-3">
          <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Codes</div>
          <div id="icd10-display" class="text-sm font-semibold text-slate-700 mt-1">ICD-10: —</div>
          <div id="snomed-display" class="text-sm font-semibold text-slate-700 mt-1">SNOMED: —</div>
        </div>
        <div class="p-3 border rounded-md">
          <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Quick Actions</div>
          <div class="flex gap-2">
            <button id="copyLinkBtn" class="px-2 py-1 border rounded" aria-label="Copy link">Copy link</button>
            <button id="shareBtn" class="px-2 py-1 border rounded" aria-label="Share">Share</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="mt-4">
      <div role="tablist" aria-label="Patient tabs" class="flex gap-2 mb-3" id="tabs" tabindex="0">
        <button id="tab-overview" role="tab" aria-selected="true" aria-controls="panel-overview" class="px-3 py-1 text-sm font-bold bg-indigo-600 text-white rounded" onclick="switchTab('overview')">Overview</button>
        <button id="tab-timeline" role="tab" aria-selected="false" aria-controls="panel-timeline" class="px-3 py-1 text-sm font-bold border rounded" onclick="switchTab('timeline')">Timeline</button>
        <button id="tab-molecular" role="tab" aria-selected="false" aria-controls="panel-molecular" class="px-3 py-1 text-sm font-bold border rounded" onclick="switchTab('molecular')">Molecular</button>
        <button id="tab-labs" role="tab" aria-selected="false" aria-controls="panel-labs" class="px-3 py-1 text-sm font-bold border rounded" onclick="switchTab('labs')">Labs</button>
      </div>

      <div id="panel-overview" role="tabpanel"></div>
      <div id="panel-timeline" role="tabpanel" hidden></div>
      <div id="panel-molecular" role="tabpanel" hidden></div>
      <div id="panel-labs" role="tabpanel" hidden></div>
    </div>
  </section>

  <!-- Sidebars -->
  <div id="sidebarBackdrop" onclick="closeSidebar()" class="fixed inset-0 bg-slate-900/20 z-40 hidden" aria-hidden="true"></div>
  <aside id="eventSidebar" class="fixed top-0 right-0 bottom-0 w-[450px] bg-white z-50 transform translate-x-full transition-transform border-l" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="p-5 border-b flex justify-between items-start">
      <div>
        <div id="sidebarDate" class="text-[10px] text-slate-400"></div>
        <h3 id="sidebarEvent" class="text-lg font-bold"></h3>
      </div>
      <button onclick="closeSidebar()" aria-label="Close event sidebar" class="p-1 rounded hover:bg-slate-100">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div id="sidebarContent" class="p-6 overflow-y-auto"></div>
    <div class="p-4 border-t text-right">
      <button onclick="closeSidebar()" class="px-4 py-2 bg-indigo-600 text-white rounded">Done</button>
    </div>
  </aside>

  <div id="labSidebarBackdrop" onclick="closeLabSidebar()" class="fixed inset-0 bg-slate-900/20 z-[60] hidden" aria-hidden="true"></div>
  <aside id="labSidebar" class="fixed top-0 right-0 bottom-0 w-[520px] bg-white z-[70] transform translate-x-full transition-transform border-l" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="p-5 border-b flex justify-between items-center">
      <div>
        <h3 id="labSidebarTitle" class="text-lg font-black"></h3>
        <p class="text-[10px] text-slate-400 uppercase">Safety & Trend Analysis</p>
      </div>
      <button onclick="closeLabSidebar()" class="p-2 rounded-full hover:bg-slate-100" aria-label="Close lab sidebar">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>

    <div class="p-6 overflow-y-auto">
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-indigo-50 p-4 rounded border">
          <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Current Level</span>
          <div class="flex items-baseline gap-2">
            <span id="labSidebarValue" class="text-3xl font-black text-indigo-900"></span>
            <span id="labSidebarUnit" class="text-xs text-indigo-400"></span>
          </div>
        </div>
        <div class="pl-4 border-l">
          <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Reference Range</span>
          <div id="labSidebarRange" class="text-sm font-bold text-slate-600 mb-2"></div>
          <div id="labSidebarStatus"></div>
        </div>
      </div>

      <div>
        <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2"><i data-lucide="activity" class="w-3 h-3"></i>Historical Trend</h4>
        <div class="h-[280px] w-full relative border rounded p-2">
          <canvas id="sidebarLabChart" aria-label="Lab trend chart"></canvas>
        </div>
      </div>
    </div>

    <div class="p-4 border-t text-center">
      <p class="text-[10px] text-slate-400">Data is for clinical monitoring only. Treat per protocol guidelines.</p>
    </div>
  </aside>

</main>

<script>
/* -----------------------
   App state & helpers
   ----------------------- */
let PATIENTS = [];
let selectedPt = null;
let charts = [];
let sidebarChartInstance = null;

/* Safe utility to parse ranges like "8 - 48" or "< 3.0" */
function parseRange(rangeStr) {
  if (!rangeStr) return null;
  if (typeof rangeStr !== 'string') return null;
  const s = rangeStr.replace(/\s/g, '');
  if (s.includes('-')) {
    const [a,b] = s.split('-').map(x => parseFloat(x));
    if (!isNaN(a) && !isNaN(b)) return { min: a, max: b };
  }
  if (s.startsWith('<')) {
    const val = parseFloat(s.replace('<',''));
    if (!isNaN(val)) return { min: 0, max: val };
  }
  return null;
}

function statusClass(status) {
  if (!status) return 'bg-baseline';
  const s = status.toLowerCase();
  if (s.includes('pd') || s.includes('progression')) return 'bg-pd';
  if (s.includes('pr') || s.includes('partial')) return 'bg-pr';
  if (s.includes('sd') || s.includes('stable')) return 'bg-sd';
  if (s.includes('cr') || s.includes('complete')) return 'bg-cr';
  return 'bg-baseline';
}

/* -----------------------
   Load dataset
   ----------------------- */
async function loadPatients() {
  try {
    const res = await fetch('/data/patients.json');
    const data = await res.json();
    PATIENTS = data;
    const selector = document.getElementById('patientSelect');
    selector.innerHTML = '';
    PATIENTS.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.ID;
      opt.innerText = `${p.ID} — ${p.Name}`;
      selector.appendChild(opt);
    });
    selector.value = PATIENTS[0].ID;
    selectedPt = PATIENTS[0];
    renderDashboard();
  } catch (err) {
    console.error('Failed to load patients', err);
    document.getElementById('clinicalUpdates').innerText = 'Failed to load dataset.';
  }
}

/* -----------------------
   ICD & SNOMED lookups
   ----------------------- */
async function fetchICD10(dxString){
  const displayEl = document.getElementById('icd10-display');
  if (!displayEl) return;
  displayEl.innerHTML = '<span class="text-slate-400 animate-pulse">Fetching ICD-10...</span>';
  let searchTerm = dxString.split('(')[0].trim();
  const map = { 'NSCLC':'Malignant neoplasm of lung', 'Breast':'Malignant neoplasm of breast', 'Colorectal':'Malignant neoplasm of colon' };
  if (map[searchTerm]) searchTerm = map[searchTerm];
  try {
    const resp = await fetch(`https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms=${encodeURIComponent(searchTerm)}&maxList=1`);
    const data = await resp.json();
    if (data[3] && data[3].length) {
      const code = data[3][0][0];
      const desc = data[3][0][1];
      displayEl.innerHTML = `<div class="flex items-center gap-1.5 mt-1"><span class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded text-[9px] font-black">ICD-10</span><span class="ml-2 text-sm font-bold">${code}</span><span class="text-xs text-slate-400 ml-2">${desc}</span></div>`;
      return;
    } else {
      displayEl.innerHTML = '<span class="text-[10px] text-slate-400 italic">Code not found</span>';
    }
  } catch (err) { console.warn('ICD fetch failed', err); displayEl.innerHTML = '<span class="text-[10px] text-red-400">ICD lookup failed</span>'; }
}

async function fetchSNOMED(term) {
  const displayEl = document.getElementById('snomed-display');
  if (!displayEl) return;
  displayEl.innerHTML = '<span class="text-slate-400 animate-pulse">Looking up SNOMED...</span>';
  try {
    const resp = await fetch(`/api/snomed?term=${encodeURIComponent(term)}`);
    if (!resp.ok) {
      displayEl.innerHTML = '<span class="text-[10px] text-slate-400 italic">SNOMED lookup not available</span>';
      return;
    }
    const json = await resp.json();
    // handle Snowstorm / generic responses
    const item = (json.items && json.items.length && json.items[0]) || (json.entry && json.entry[0] && json.entry[0].resource) || null;
    if (item) {
      const id = item.conceptId || item.id || item.code || 'n/a';
      const desc = item.fsn || item.term || item.display || term;
      displayEl.innerHTML = `<div class="flex items-center gap-1.5 mt-1"><span class="bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded text-[9px] font-black">SNOMED</span><span class="ml-2 text-sm font-bold">${id}</span><span class="text-xs text-slate-400 ml-2">${desc}</span></div>`;
      return;
    }
    displayEl.innerHTML = '<span class="text-[10px] text-slate-400 italic">SNOMED lookup not available</span>';
  } catch (err) {
    console.warn('SNOMED error', err);
    displayEl.innerHTML = '<span class="text-[10px] text-slate-400 italic">SNOMED lookup failed</span>';
  }
}

/* -----------------------
   Rendering functions
   ----------------------- */

function clearCharts() {
  charts.forEach(c => { try { c.destroy(); } catch(e){} });
  charts = [];
  if (sidebarChartInstance) { try { sidebarChartInstance.destroy(); } catch(e) {} sidebarChartInstance = null; }
}

function renderHeader() {
  const header = document.getElementById('topSummary');
  header.innerHTML = `
    <div>
      <div class="text-[10px] font-bold text-slate-400 uppercase">Patient</div>
      <div class="text-lg font-bold text-indigo-900">${selectedPt.Name} <span class="text-sm text-slate-400 font-medium">(${selectedPt.ID})</span></div>
      <div class="text-sm mt-2">${selectedPt.Age}Y • ${selectedPt.Sex} • ${selectedPt.PS}</div>
      <div class="text-sm mt-1 font-semibold text-indigo-700">${selectedPt.Dx} • Stage ${selectedPt.Stage}</div>
    </div>
  `;
  const updatesBox = document.getElementById('clinicalUpdates');
  if (updatesBox) {
    updatesBox.innerHTML = `<div class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-2">Key Clinical Changes</div>
      <div class="space-y-1">${(selectedPt.History||[]).map(h=>`<div class="text-sm font-bold text-indigo-900">• ${h}</div>`).join('')}</div>`;
  }
  fetchICD10(selectedPt.Dx);
  fetchSNOMED(selectedPt.Dx);
}

function renderOverviewPanel() {
  const panel = document.getElementById('panel-overview');
  panel.innerHTML = `
    <div class="grid grid-cols-12 gap-6">
      <div class="col-span-12 lg:col-span-8 space-y-6">
        <section class="p-4 border rounded">
          <h2 class="text-sm font-bold mb-3">Treatment History (By Line)</h2>
          <div id="treatmentLines" class="space-y-3"></div>
        </section>
        <section class="p-4 border rounded">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-bold">Labs & Safety Monitor</h2>
            <span class="text-xs text-slate-400 italic">For monitoring trends only</span>
          </div>
          <div id="labsGrid" class="mt-3"></div>
        </section>
      </div>

      <aside class="col-span-12 lg:col-span-4 space-y-4">
        <section class="p-4 border rounded bg-slate-50">
          <h3 class="text-xs font-bold text-indigo-900 uppercase mb-3">AI-Assisted Clinical Summary (For Review Only)</h3>
          <ul id="aiSummaryPoints" class="text-sm space-y-2"></ul>
          <div class="mt-4">
            <h4 class="text-xs font-bold text-indigo-900 uppercase">Clinical Considerations</h4>
            <ul id="aiNextSteps" class="text-sm mt-2"></ul>
          </div>
        </section>
        <section class="p-4 border rounded">
          <h3 class="text-sm font-bold mb-2">Molecular Profile</h3>
          <div id="molecularList"></div>
        </section>
      </aside>
    </div>
  `;
  renderTreatments();
  renderLabs();
  renderAISummary();
  renderMolecular();
}

function renderTimelinePanel() {
  const panel = document.getElementById('panel-timeline');
  panel.innerHTML = `
    <section class="p-4 border rounded">
      <h3 class="text-sm font-bold mb-4">Longitudinal Disease Course</h3>
      <div class="grid grid-cols-1 md:grid-cols-10 gap-6">
        <div id="timelineContainer" class="md:col-span-4 relative p-2 border rounded" tabindex="0" aria-label="Timeline"></div>
        <div class="md:col-span-6 border-l pl-4">
          <canvas id="biomarkerChart" style="height:260px; width:100%"></canvas>
        </div>
      </div>
    </section>
  `;
  renderTimeline();
}

function renderMolecularPanel() {
  const panel = document.getElementById('panel-molecular');
  panel.innerHTML = `
    <section class="p-4 border rounded">
      <h3 class="text-sm font-bold mb-3">Molecular & Biomarker Detail</h3>
      <div id="molecularListFull"></div>
    </section>
  `;
  renderMolecular();
}

function renderLabsPanel() {
  const panel = document.getElementById('panel-labs');
  panel.innerHTML = `<section class="p-4 border rounded"><h3 class="text-sm font-bold mb-3">Full Lab Panel</h3><div id="labsListFull"></div></section>`;
  const lf = document.getElementById('labsListFull');
  lf.innerHTML = `<div class="grid md:grid-cols-2 gap-4">${(selectedPt.Labs||[]).map(l=>`
    <div class="p-3 border rounded">
      <div class="text-xs text-slate-500 font-bold">${l.name}</div>
      <div class="text-lg font-black">${l.val} <span class="text-sm text-slate-400">${l.unit||''}</span></div>
      <div class="text-sm text-slate-500 mt-2">Range: ${l.range||'n/a'} | Trend: ${l.trend||'n/a'}</div>
    </div>`).join('')}</div>`;
}

function renderTimeline() {
  const list = document.getElementById('timelineContainer');
  if (!list) return;
  list.innerHTML = `<div class="timeline-line"></div>`;
  const timeline = (selectedPt.Timeline || []).slice().sort((a,b)=> new Date(a.date) - new Date(b.date));
  timeline.forEach((t,i) => {
    const item = document.createElement('div');
    item.className = 'pl-10 pb-6 relative group cursor-pointer';
    item.setAttribute('tabindex','0');
    item.onclick = () => openModal(t);
    item.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') openModal(t); };
    item.innerHTML = `
      <div class="absolute left-0 top-1">
        <div class="w-4 h-4 rounded-full border-2 ${i===timeline.length-1 ? 'bg-indigo-600 border-indigo-500' : 'bg-white border-slate-300'}"></div>
      </div>
      <div class="text-[10px] text-slate-500 font-bold">${t.date} <span class="ml-2 status-badge ${statusClass(t.status)}">${t.status}</span></div>
      <div class="text-sm font-bold text-slate-800">${t.event}</div>
      <div class="text-xs text-slate-400 mt-1">${t.detail}</div>
    `;
    list.appendChild(item);
  });

  // biomarker chart
  renderBiomarkerChart();
}

function renderBiomarkerChart() {
  const canvas = document.getElementById('biomarkerChart');
  if (!canvas) return;
  try { if (charts.length) { charts.forEach(c=>c.destroy()); charts = []; } } catch(e){}
  const plotData = (selectedPt.Timeline||[]).filter(t => t.cea !== undefined);
  const labels = plotData.map(p=>p.date);
  const data = plotData.map(p=>p.cea);

  const ctx = canvas.getContext('2d');
  const gradient = ctx.createLinearGradient(0,0,0,300);
  gradient.addColorStop(0, 'rgba(79,70,229,0.18)');
  gradient.addColorStop(1, 'rgba(79,70,229,0.0)');

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'CEA (ng/mL)',
        data,
        borderColor: '#4f46e5',
        backgroundColor: gradient,
        borderWidth: 2.5,
        pointRadius: 4,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: true } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'CEA (ng/mL)' } },
        x: { ticks: { maxRotation: 45, minRotation: 45 } }
      }
    }
  });
  charts.push(chart);
}

/* Modal sidebar */
let lastFocused = null;
function openModal(data) {
  lastFocused = document.activeElement;
  document.getElementById('sidebarDate').innerText = data.date;
  document.getElementById('sidebarEvent').innerText = data.event;
  document.getElementById('sidebarContent').innerHTML = `
    <div>
      <h4 class="font-bold">Findings</h4>
      <p class="text-sm text-slate-600">${data.report?.findings || '—'}</p>
    </div>
    <div class="mt-3">
      <h4 class="font-bold">Impression</h4>
      <p class="text-sm text-slate-600">${data.report?.impression || '—'}</p>
    </div>
    <div class="mt-3">
      <h4 class="font-bold">Plan</h4>
      <p class="text-sm text-slate-600">${data.report?.plan || '—'}</p>
    </div>
  `;
  document.getElementById('sidebarBackdrop').classList.remove('hidden');
  setTimeout(()=> document.getElementById('sidebarBackdrop').classList.add('opacity-50'), 10);
  const sb = document.getElementById('eventSidebar');
  sb.classList.remove('translate-x-full');
  sb.setAttribute('aria-hidden', 'false');
  setTimeout(()=> sb.querySelector('button')?.focus(), 120);
}
function closeSidebar() {
  document.getElementById('eventSidebar').classList.add('translate-x-full');
  document.getElementById('sidebarBackdrop').classList.add('hidden');
  document.getElementById('eventSidebar').setAttribute('aria-hidden','true');
  if (lastFocused) lastFocused.focus();
}

/* Labs & sidebars */
function renderLabs() {
  const container = document.getElementById('labsGrid');
  if (!container) return;
  container.innerHTML = '';
  container.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4';
  const categories = {
    'Hematology': ['Hb','WBC','Plt','Platelets','Hgb'],
    'Liver Function': ['AST','ALT','Bilirubin','Albumin','ALP'],
    'Renal & Metabolic': ['Creatinine','Cr','eGFR','Sodium','Potassium'],
    'Tumor Markers': ['CEA','PSA','CA 15-3','CA 27-29','CA 125','AFP']
  };

  Object.entries(categories).forEach(([cat, kws]) => {
    const catLabs = (selectedPt.Labs||[]).filter(l => kws.some(k => l.name.includes(k) || l.name === k));
    if (!catLabs.length) return;
    const group = document.createElement('div');
    group.className = 'flex flex-col gap-3';
    group.innerHTML = `<div class="flex items-center gap-2 border-b pb-2 mb-1"><span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span><h3 class="text-xs font-bold text-slate-500 uppercase">${cat}</h3></div><div class="grid grid-cols-2 gap-3">${catLabs.map(l=>{
      const isAb = l.status === 'abnormal';
      const isMissing = l.status === 'missing';
      const border = isAb ? 'border-red-200' : 'border-slate-200';
      const bg = isAb ? 'bg-red-50' : 'bg-white';
      const text = isAb ? 'text-red-700' : 'text-slate-700';
      const icon = isMissing ? 'help-circle' : (l.trend==='up' ? 'arrow-up-right' : l.trend==='down' ? 'arrow-down-right' : 'minus');
      return `<div role="button" tabindex="0" onclick="openLabSidebar(${selectedPt.Labs.indexOf(l)})" class="p-3 rounded border ${border} ${bg} cursor-pointer group">
        <div class="flex justify-between items-start mb-1">
          <span class="text-[10px] font-bold text-slate-400 uppercase">${l.name}</span>
          <i data-lucide="${icon}" class="w-3 h-3 ${isAb ? 'text-red-500' : 'text-slate-300'}"></i>
        </div>
        <div class="flex items-baseline gap-1">
          <span class="text-sm font-black ${text}">${l.val}</span>
          <span class="text-[9px] text-slate-400">${l.unit || ''}</span>
        </div>
        ${isAb ? '<div class="absolute bottom-1 right-1 w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>' : ''}
      </div>`;
    }).join('')}</div>`;
    container.appendChild(group);
  });

  try { lucide.createIcons(); } catch(e){}
}

function openLabSidebar(index) {
  const l = selectedPt.Labs[index];
  if (!l) return;
  document.getElementById('labSidebarTitle').innerText = l.name;
  document.getElementById('labSidebarValue').innerText = l.val;
  document.getElementById('labSidebarUnit').innerText = l.unit || '';
  document.getElementById('labSidebarRange').innerText = l.range || 'n/a';
  const statusEl = document.getElementById('labSidebarStatus');
  const isAb = l.status === 'abnormal';
  statusEl.innerHTML = `<span class="inline-flex items-center gap-1 px-2 py-1 rounded ${isAb ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">${isAb ? 'Abnormal' : 'Normal'}</span>`;

  document.getElementById('labSidebarBackdrop').classList.remove('hidden');
  document.getElementById('labSidebar').classList.remove('translate-x-full');
  document.getElementById('labSidebar').setAttribute('aria-hidden','false');

  // build chart
  const ctx = document.getElementById('sidebarLabChart').getContext('2d');
  if (sidebarChartInstance) try { sidebarChartInstance.destroy(); } catch(e){}
  const dataPoints = (l.history && l.history.length) ? l.history : [(parseFloat(l.val) || 0)];
  const labels = dataPoints.map((_, i) => i === dataPoints.length - 1 ? 'Current' : `Prior ${dataPoints.length - 1 - i}`);
  const range = parseRange(l.range);
  const datasets = [{ label: l.name, data: dataPoints, borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.12)', fill: true, tension: 0.3 }];

  if (range) {
    if (typeof range.max === 'number') datasets.push({ label: 'Upper Limit', data: Array(labels.length).fill(range.max), borderColor: '#f87171', borderDash: [5,5], pointRadius: 0, fill: false });
    if (typeof range.min === 'number' && range.min > 0) datasets.push({ label: 'Lower Limit', data: Array(labels.length).fill(range.min), borderColor: '#f87171', borderDash: [5,5], pointRadius: 0, fill: false });
  }

  sidebarChartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });

  setTimeout(()=> document.getElementById('labSidebar').querySelector('button')?.focus(), 100);
}

function closeLabSidebar() {
  document.getElementById('labSidebar').classList.add('translate-x-full');
  document.getElementById('labSidebarBackdrop').classList.add('hidden');
  document.getElementById('labSidebar').setAttribute('aria-hidden','true');
}

/* Treatments rendering */
function toggleTreatment(index) {
  const content = document.getElementById(`tx-detail-${index}`);
  const btn = document.getElementById(`tx-toggle-${index}`);
  if (!content || !btn) return;
  const expanded = btn.getAttribute('aria-expanded') === 'true';
  if (!expanded) {
    content.classList.remove('hidden'); btn.setAttribute('aria-expanded','true');
  } else {
    content.classList.add('hidden'); btn.setAttribute('aria-expanded','false');
  }
}

function renderTreatments() {
  const container = document.getElementById('treatmentLines');
  if (!container) return;
  container.innerHTML = '';
  (selectedPt.Treatments||[]).forEach((t, index) => {
    const stop = (t.stop||'').toLowerCase();
    const resp = (t.resp||'').toLowerCase();
    let themeBorder = 'border-slate-200', themeText='text-slate-700';
    if (stop.includes('ongoing')) { themeBorder='border-emerald-500'; themeText='text-emerald-700'; }
    else if (stop.includes('progression') || stop.includes('failure')) { themeBorder='border-red-400'; themeText='text-red-700'; }
    else if (resp === 'pr' || resp === 'cr') { themeBorder='border-indigo-300'; themeText='text-indigo-700'; }

    const card = document.createElement('div');
    card.className = 'mb-4 rounded border overflow-hidden';
    card.innerHTML = `
      <div id="tx-toggle-${index}" role="button" aria-expanded="false" onclick="toggleTreatment(${index})" class="p-4 bg-white cursor-pointer flex items-center justify-between ${themeBorder}">
        <div>
          <div class="text-sm font-bold">${t.drug} ${t.end==='Current' ? '<span class="text-xs bg-emerald-100 px-2 py-0.5 rounded">Active</span>' : ''}</div>
          <div class="text-xs text-slate-500">${t.start} — ${t.end} • ${getDuration(t.start,t.end)}</div>
        </div>
        <div class="text-right">
          <div class="text-[10px] text-slate-400 uppercase">Response</div>
          <div class="font-semibold ${themeText}">${t.resp}</div>
        </div>
      </div>
      <div id="tx-detail-${index}" class="hidden p-4 bg-slate-50 border-t">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <h5 class="text-xs font-bold text-slate-400 uppercase">Context & Rationale</h5>
            <p class="text-sm text-slate-700">${t.extended?.rationale || '—'}</p>
            <div class="mt-2 text-xs"><strong>Dosing:</strong> ${t.extended?.dosing || '—'}</div>
          </div>
          <div>
            <h5 class="text-xs font-bold text-slate-400 uppercase">Safety Profile</h5>
            <p class="text-sm text-slate-700">${t.extended?.toxicity || '—'}</p>
          </div>
          <div>
            <h5 class="text-xs font-bold text-slate-400 uppercase">Outcome</h5>
            <p class="text-sm text-slate-700">${t.extended?.outcome || '—'}</p>
          </div>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
  try { lucide.createIcons(); } catch(e){}
}

/* Duration helper */
function getDuration(start, end) {
  try {
    const s = new Date(start + '-01');
    const e = (end === 'Current') ? new Date() : new Date(end + '-01');
    let months = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth());
    months = Math.max(0, months);
    if (months < 1) return '<1 month';
    const years = Math.floor(months / 12);
    if (years >= 1) return `${years}y ${months % 12}m`;
    return `${months} months`;
  } catch(e) { return 'n/a'; }
}

/* AI summary (deterministic rule-based) */
function generateAISummary(pt) {
  const summary = [];
  const latest = pt.Timeline && pt.Timeline.length ? pt.Timeline[pt.Timeline.length-1] : null;
  if (latest) summary.push(`Current disease status: ${latest.status} (latest: ${latest.date} — ${latest.event}).`);
  else summary.push("No timeline events available.");

  const active = pt.Treatments?.find(t => t.end === 'Current');
  if (active) summary.push(`On active therapy: Line ${active.line} — ${active.drug} (response: ${active.resp}).`);
  else if (pt.Line !== undefined) summary.push(`No active therapy entry found. Charted active arc: Line ${pt.Line}.`);

  const markerLabs = (pt.Labs||[]).filter(l => /CEA|PSA|CA 15|CA 27|CA 125|AFP/i.test(l.name));
  markerLabs.forEach(lab=>{
    if (lab.trend === 'up') summary.push(`${lab.name} trending up — current ${lab.val}${lab.unit? ' ' + lab.unit : ''}.`);
    else if (lab.trend === 'down') summary.push(`${lab.name} trending down — current ${lab.val}${lab.unit? ' ' + lab.unit : ''}.`);
    else summary.push(`${lab.name}: ${lab.val}${lab.unit? ' ' + lab.unit : ''}.`);
  });

  const abnorm = (pt.Labs||[]).filter(l=>l.status==='abnormal');
  if (abnorm.length) summary.push(`Abnormal labs: ${abnorm.map(a=>a.name+'('+a.val+')').join(', ')} — consider trend review.`);

  if (pt.EGFR && pt.EGFR !== 'Negative') summary.push(`Molecular: ${pt.EGFR} detected — consider EGFR-targeted therapies.`);
  if (pt.ALK && (pt.ALK.toLowerCase()==='positive')) summary.push('Molecular: ALK-positive — consider CNS-penetrant TKIs if brain disease present.');
  if (pt.MSI && pt.MSI.toUpperCase() === 'MSI-H') summary.push('Molecular: MSI-High — favorable for immunotherapy.');

  if (summary.length === 0) summary.push('Insufficient data to generate AI summary.');
  return summary;
}
function generateNextSteps(pt) {
  const steps = [];
  const latest = pt.Timeline && pt.Timeline.length ? pt.Timeline[pt.Timeline.length-1] : null;
  if (latest && (latest.status === 'PR' || latest.status === 'SD')) steps.push('Continue surveillance imaging per routine cadence to confirm response durability.');
  if (latest && latest.status === 'PD') steps.push('Reassess pattern of progression and consider restaging/imaging to define next options.');
  const abnorm = (pt.Labs||[]).filter(l=>l.status==='abnormal');
  if (abnorm.length) steps.push(`Trend & evaluate: ${abnorm.map(l=>l.name).join(', ')} for possible toxicity or disease effect.`);
  const missing = (pt.Labs||[]).filter(l=>l.status==='missing');
  if (missing.length) steps.push(`Missing labs: ${missing.map(m=>m.name).join(', ')} — obtain if possible.`);
  if (steps.length===0) steps.push('No immediate actions identified; maintain current plan and routine monitoring.');
  return steps;
}
function renderAISummary() {
  const points = generateAISummary(selectedPt);
  const next = generateNextSteps(selectedPt);
  document.getElementById('aiSummaryPoints').innerHTML = points.map(p => `<li class="text-sm">${p}</li>`).join('');
  document.getElementById('aiNextSteps').innerHTML = next.map(n => `<li class="text-sm">${n}</li>`).join('');
}

/* Molecular */
function renderMolecular() {
  const el = document.getElementById('molecularList');
  if (!el) return;
  const markers = ['EGFR','ALK','KRAS','PDL1','MSI','TMB','ER','PR','HER2'];
  el.innerHTML = markers.filter(m=>selectedPt[m]).map(m => `<div class="flex justify-between py-2 border-b"><span class="text-xs font-bold text-slate-400 uppercase">${m}</span><span class="text-sm font-bold ${selectedPt[m]!=='Negative' && selectedPt[m]!=='MSS' ? 'text-indigo-600':'text-slate-500'}">${selectedPt[m]}</span></div>`).join('') + `<div class="mt-3 text-sm italic text-slate-600">${selectedPt.Biology || ''}</div>`;
}

/* -----------------------
   Tabs
   ----------------------- */
function switchTab(tab) {
  const tabs = ['overview','timeline','molecular','labs'];
  tabs.forEach(t => {
    const btn = document.getElementById(`tab-${t}`);
    const panel = document.getElementById(`panel-${t}`);
    if (t === tab) {
      btn.setAttribute('aria-selected','true'); btn.classList.add('bg-indigo-600','text-white'); btn.classList.remove('border');
      panel.removeAttribute('hidden');
      if (t === 'overview') renderOverviewPanel();
      if (t === 'timeline') renderTimelinePanel();
      if (t === 'molecular') renderMolecularPanel();
      if (t === 'labs') renderLabsPanel();
    } else {
      btn.setAttribute('aria-selected','false'); btn.classList.remove('bg-indigo-600','text-white'); btn.classList.add('border');
      panel.setAttribute('hidden','');
    }
  });
}

/* -----------------------
   Export PDF (chart embedding + multi-page)
   ----------------------- */
async function exportPatientSummaryPDF() {
  const wrapper = document.createElement('div');
  wrapper.style.width = '1000px';
  wrapper.style.padding = '24px';
  wrapper.style.background = '#fff';
  // Clone header and overview (current visible panel)
  const updates = document.getElementById('clinicalUpdates').cloneNode(true);
  const top = document.getElementById('topSummary').cloneNode(true);
  const panels = document.querySelectorAll('[role="tabpanel"]');
  let visible = null;
  panels.forEach(p => { if (!p.hasAttribute('hidden')) visible = p.cloneNode(true); });
  if (!visible) visible = document.getElementById('panel-overview').cloneNode(true);

  // Replace canvas charts with images (chart.toBase64Image)
  // Create a copy of visible panel and replace existing chart canvases with img elements that contain the data URL.
  const visibleCopy = visible;
  // find charts on page and inject images into the visibleCopy where appropriate
  // biomarker chart
  try {
    if (charts && charts.length) {
      const bChart = charts[0];
      if (bChart) {
        const dataUrl = bChart.toBase64Image();
        const img = document.createElement('img');
        img.src = dataUrl;
        img.style.width = '100%';
        img.style.maxWidth = '900px';
        img.style.display = 'block';
        // place at top of visibleCopy
        visibleCopy.insertBefore(img, visibleCopy.firstChild);
      }
    }
  } catch (e) { console.warn('embed chart failed', e); }

  wrapper.appendChild(updates);
  wrapper.appendChild(top);
  wrapper.appendChild(visibleCopy);
  document.body.appendChild(wrapper);

  try {
    const canvas = await html2canvas(wrapper, { scale: 2, useCORS: true, allowTaint: true });
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
    const margin = 40;
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const imgWidth = pageWidth - margin * 2;
    const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

    // If content fits single page, add directly
    if (imgHeight < pageHeight - margin * 2) {
      pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
    } else {
      // Multi-page split: draw progressively
      let remainingHeight = imgHeight;
      let position = 0;
      const canvasImage = new Image();
      canvasImage.src = imgData;
      await new Promise((resolve) => { canvasImage.onload = resolve; });
      const scale = imgWidth / canvasImage.width;
      const sliceHeightPx = Math.floor((pageHeight - margin * 2) / scale);
      let sY = 0;
      while (remainingHeight > 0) {
        const canvasSlice = document.createElement('canvas');
        canvasSlice.width = canvasImage.width;
        canvasSlice.height = Math.min(sliceHeightPx, canvasImage.height - sY);
        const ctx = canvasSlice.getContext('2d');
        ctx.drawImage(canvasImage, 0, sY, canvasSlice.width, canvasSlice.height, 0, 0, canvasSlice.width, canvasSlice.height);
        const sliceData = canvasSlice.toDataURL('image/png');
        if (position > 0) pdf.addPage();
        pdf.addImage(sliceData, 'PNG', margin, margin, imgWidth, (canvasSlice.height * scale));
        sY += canvasSlice.height;
        remainingHeight -= canvasSlice.height;
        position++;
      }
    }

    const filename = `${selectedPt.ID}_summary.pdf`;
    pdf.save(filename);
  } catch (err) {
    console.error('PDF export failed', err);
    alert('PDF export failed. Check console for details.');
  } finally {
    document.body.removeChild(wrapper);
  }
}

/* -----------------------
   Small helpers & actions
   ----------------------- */
function copyPatientLink() {
  const link = `${location.origin}${location.pathname}?patient=${selectedPt.ID}`;
  navigator.clipboard.writeText(link).then(()=> alert('Patient link copied')).catch(()=> alert('Copy failed'));
}
function openShareModal() { alert('Share placeholder — integrate with your sharing endpoint.'); }

/* -----------------------
   Orchestration
   ----------------------- */
function renderDashboard() {
  clearCharts();
  renderHeader();
  // default to overview
  const selectedTab = Array.from(['overview','timeline','molecular','labs']).find(t => document.getElementById(`tab-${t}`) && document.getElementById(`tab-${t}`).getAttribute('aria-selected') === 'true') || 'overview';
  switchTab(selectedTab);
}

/* init */
async function init() {
  document.getElementById('patientSelect').addEventListener('change', (e)=> {
    const id = e.target.value;
    selectedPt = PATIENTS.find(p=>p.ID===id);
    renderDashboard();
  });

  document.getElementById('exportBtn').addEventListener('click', async ()=> {
    await exportPatientSummaryPDF();
  });

  document.getElementById('copyLinkBtn').addEventListener('click', copyPatientLink);
  document.getElementById('shareBtn').addEventListener('click', openShareModal);

  // keyboard navigation for tabs (arrow left/right/home/end)
  document.getElementById('tabs').addEventListener('keydown', (e) => {
    const keys = ['ArrowLeft','ArrowRight','Home','End'];
    if (!keys.includes(e.key)) return;
    e.preventDefault();
    const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
    let idx = tabs.findIndex(t => t.getAttribute('aria-selected') === 'true');
    if (e.key === 'ArrowLeft') idx = (idx - 1 + tabs.length) % tabs.length;
    if (e.key === 'ArrowRight') idx = (idx + 1) % tabs.length;
    if (e.key === 'Home') idx = 0;
    if (e.key === 'End') idx = tabs.length - 1;
    tabs[idx].focus();
    tabs[idx].click();
  });

  // load patients dataset then render
  await loadPatients();
  try { lucide.createIcons(); } catch(e){}
}

window.onload = init;
</script>

</body>
</html>
